# 架构设计文档

## 1. 总体架构

### 1.1 架构模式
本系统采用经典的 **MVC三层架构** + **DAO模式**，实现了业务逻辑、数据访问和表现层的分离。

```
┌──────────────────────────────────────────────────┐
│                  Presentation Layer               │
│           (表现层 - JSP + HTML + JS)              │
│  ┌────────┐  ┌────────┐  ┌────────┐              │
│  │登录页面│  │管理页面│  │详情页面│              │
│  └────────┘  └────────┘  └────────┘              │
└──────────────────┬───────────────────────────────┘
                   │ HTTP Request/Response
┌──────────────────▼───────────────────────────────┐
│                  Controller Layer                 │
│              (控制层 - Servlet)                   │
│  ┌──────────────────────────────────────┐        │
│  │        BaseController (抽象类)        │        │
│  │        - 模板方法模式                │        │
│  │        - 统一请求处理                │        │
│  └──────────────┬───────────────────────┘        │
│                 │                                 │
│  ┌──────────────▼───────────────────────┐        │
│  │  具体Controller (CustomerController   │        │
│  │  RoomController, BookingController等) │        │
│  └──────────────────────────────────────┘        │
└──────────────────┬───────────────────────────────┘
                   │ 调用Service接口
┌──────────────────▼───────────────────────────────┐
│                  Service Layer                    │
│             (业务逻辑层 - Service)                │
│  ┌─────────────────────────────────────┐         │
│  │       ServiceFactory (工厂类)       │         │
│  └─────────────┬───────────────────────┘         │
│                │                                  │
│  ┌─────────────▼──────────┬──────────────┐       │
│  │ CustomerService        │ RoomService   │       │
│  │ ├─ 客户业务逻辑        │ ├─ 房间业务   │       │
│  │ ├─ 数据验证            │ ├─ 状态管理   │       │
│  │ └─ 业务规则            │ └─ 类型管理   │       │
│  └────────────────────────┴──────────────┘       │
│                                                   │
│  ┌─────────────────────────────────────┐         │
│  │      PriceCalculationStrategy        │         │
│  │      (价格计算策略 - 策略模式)       │         │
│  └─────────────────────────────────────┘         │
└──────────────────┬───────────────────────────────┘
                   │ 调用DAO接口
┌──────────────────▼───────────────────────────────┐
│                   DAO Layer                       │
│              (数据访问层 - DAO)                   │
│  ┌─────────────────────────────────────┐         │
│  │         DAOFactory (工厂类)         │         │
│  └─────────────┬───────────────────────┘         │
│                │                                  │
│  ┌─────────────▼──────────┬──────────────┐       │
│  │ CustomerDAO            │ RoomDAO       │       │
│  │ ├─ CRUD操作            │ ├─ CRUD操作   │       │
│  │ ├─ 条件查询            │ ├─ 状态查询   │       │
│  │ └─ 复杂查询            │ └─ 关联查询   │       │
│  └────────────────────────┴──────────────┘       │
└──────────────────┬───────────────────────────────┘
                   │ JDBC操作
┌──────────────────▼───────────────────────────────┐
│               Database Layer                      │
│          (数据库层 - MySQL 8.0)                   │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐            │
│  │users │ │custom│ │rooms │ │booking│            │
│  └──────┘ └──────┘ └──────┘ └──────┘            │
└──────────────────────────────────────────────────┘
```

### 1.2 层次职责

#### 1.2.1 表现层 (Presentation Layer)
**职责**:
- 接收用户输入
- 展示数据
- 页面跳转控制

**技术**:
- JSP
- HTML5
- CSS3
- JavaScript
- Bootstrap 5

**特点**:
- 不包含业务逻辑
- 通过EL表达式和JSTL标签展示数据
- 使用AJAX进行异步交互

#### 1.2.2 控制层 (Controller Layer)
**职责**:
- 接收HTTP请求
- 参数验证和转换
- 调用Service层
- 控制页面流转
- 统一异常处理

**技术**:
- Servlet 4.0
- Filter

**核心类**:
- `BaseController` - 抽象基类，使用模板方法模式
- `CustomerController` - 客户管理
- `RoomController` - 房间管理
- `BookingController` - 预订管理
- `UserController` - 用户管理
- `LoginController` - 登录控制
- `LogoutController` - 登出控制
- `IndexController` - 首页和统计

#### 1.2.3 业务逻辑层 (Service Layer)
**职责**:
- 实现核心业务逻辑
- 数据验证
- 事务控制
- 业务规则执行

**技术**:
- 纯Java类
- 策略模式

**核心类**:
- `CustomerService/CustomerServiceImpl`
- `RoomService/RoomServiceImpl`
- `BookingService/BookingServiceImpl`
- `UserService/UserServiceImpl`
- `PriceCalculationStrategy` (策略接口)
  - `RegularPriceStrategy`
  - `VIPPriceStrategy`

#### 1.2.4 数据访问层 (DAO Layer)
**职责**:
- 封装数据库操作
- SQL语句执行
- 结果集映射
- 连接管理

**技术**:
- JDBC
- PreparedStatement
- 自定义连接池

**核心类**:
- `CustomerDAO/CustomerDAOImpl`
- `RoomDAO/RoomDAOImpl`
- `RoomTypeDAO/RoomTypeDAOImpl`
- `BookingDAO/BookingDAOImpl`
- `UserDAO/UserDAOImpl`

## 2. 设计模式应用

### 2.1 单例模式 (Singleton Pattern)

**应用场景**: 数据库连接池、配置管理器

**实现位置**:
- `com.hotel.util.ConnectionPool`
- `com.hotel.util.ConfigManager`

**代码示例**:
```java
public class ConnectionPool {
    private static volatile ConnectionPool instance;
    
    private ConnectionPool() {
        // 私有构造函数
    }
    
    public static ConnectionPool getInstance() {
        if (instance == null) {
            synchronized (ConnectionPool.class) {
                if (instance == null) {
                    instance = new ConnectionPool();
                }
            }
        }
        return instance;
    }
}
```

**优势**:
- 全局唯一实例
- 延迟初始化
- 线程安全（双重检查锁定）
- 资源复用

---

### 2.2 工厂模式 (Factory Pattern)

**应用场景**: 创建DAO和Service对象

**实现位置**:
- `com.hotel.dao.DAOFactory`
- `com.hotel.service.ServiceFactory`

**代码示例**:
```java
public class DAOFactory {
    public static CustomerDAO createCustomerDAO() {
        return new CustomerDAOImpl();
    }
    
    public static RoomDAO createRoomDAO() {
        return new RoomDAOImpl();
    }
    
    // 其他工厂方法...
}
```

**优势**:
- 解耦对象创建和使用
- 便于替换实现
- 统一对象创建入口

---

### 2.3 策略模式 (Strategy Pattern)

**应用场景**: 价格计算

**实现位置**:
- `com.hotel.service.strategy.PriceCalculationStrategy` (接口)
- `com.hotel.service.strategy.impl.RegularPriceStrategy` (普通价格)
- `com.hotel.service.strategy.impl.VIPPriceStrategy` (VIP价格)

**代码示例**:
```java
// 策略接口
public interface PriceCalculationStrategy {
    BigDecimal calculatePrice(RoomType roomType, int days, int vipLevel);
}

// 普通价格策略
public class RegularPriceStrategy implements PriceCalculationStrategy {
    @Override
    public BigDecimal calculatePrice(RoomType roomType, int days, int vipLevel) {
        return roomType.getPrice().multiply(new BigDecimal(days));
    }
}

// VIP价格策略
public class VIPPriceStrategy implements PriceCalculationStrategy {
    @Override
    public BigDecimal calculatePrice(RoomType roomType, int days, int vipLevel) {
        BigDecimal basePrice = roomType.getPrice().multiply(new BigDecimal(days));
        BigDecimal discount = getDiscountByVipLevel(vipLevel);
        return basePrice.multiply(discount);
    }
}
```

**优势**:
- 算法族封装
- 运行时切换策略
- 易于扩展新策略
- 符合开闭原则

---

### 2.4 模板方法模式 (Template Method Pattern)

**应用场景**: Controller请求处理流程

**实现位置**:
- `com.hotel.controller.BaseController`

**代码示例**:
```java
public abstract class BaseController extends HttpServlet {
    
    // 模板方法：定义算法骨架
    private void processRequest(HttpServletRequest request, 
                                HttpServletResponse response) {
        // 1. 参数验证
        if (!validateParameters(request)) {
            handleValidationError(request, response);
            return;
        }
        
        // 2. 权限检查
        if (!checkPermission(request)) {
            handlePermissionError(request, response);
            return;
        }
        
        // 3. 业务处理（抽象方法，由子类实现）
        String result = handleBusinessLogic(request, response);
        
        // 4. 结果处理
        handleResult(request, response, result);
    }
    
    // 抽象方法：子类必须实现
    protected abstract String handleBusinessLogic(
        HttpServletRequest request, 
        HttpServletResponse response) throws Exception;
    
    // 钩子方法：子类可选择性重写
    protected boolean validateParameters(HttpServletRequest request) {
        return true;
    }
    
    protected boolean checkPermission(HttpServletRequest request) {
        return true;
    }
}
```

**优势**:
- 统一算法结构
- 减少代码重复
- 子类只需实现差异化部分
- 提高代码复用性

---

### 2.5 观察者模式 (Observer Pattern)

**应用场景**: 房间状态变更通知

**实现概念**:
当房间状态发生变化时，通知相关的观察者（如预订系统、统计系统）

**优势**:
- 对象间松耦合
- 支持广播通信
- 符合开闭原则

---

### 2.6 DAO模式 (Data Access Object Pattern)

**应用场景**: 封装所有数据访问逻辑

**实现结构**:
```
DAO接口 (CustomerDAO)
    ↓
DAO实现 (CustomerDAOImpl)
    ↓
数据库操作 (JDBC)
```

**优势**:
- 分离业务逻辑和数据访问
- 便于数据源切换
- 提高代码可测试性

## 3. 系统请求处理流程

### 3.1 用户登录流程

```
用户输入用户名密码
    ↓
login.jsp提交表单
    ↓
LoginController接收请求
    ↓
参数验证（用户名、密码非空）
    ↓
调用UserService.authenticate()
    ↓
UserDAO查询数据库
    ↓
密码MD5加密比对
    ↓
验证成功：创建Session，存储用户信息
    ↓
重定向到管理后台首页
```

### 3.2 客户添加流程

```
用户访问添加页面
    ↓
CustomerController.showAddForm()
    ↓
显示customer-add.jsp
    ↓
用户填写表单并提交
    ↓
CustomerController.saveCustomer()
    ↓
参数验证（前端+后端）
    - 姓名非空
    - 手机号格式正确
    - 身份证号格式正确
    - 邮箱格式正确（可选）
    ↓
调用CustomerService.createCustomer()
    ↓
业务验证
    - 手机号唯一性
    - 身份证号唯一性
    ↓
CustomerDAO.insert()
    ↓
执行SQL INSERT语句
    ↓
返回新增客户ID
    ↓
设置成功消息
    ↓
重定向到客户列表页
```

### 3.3 预订创建流程

```
用户访问预订添加页面
    ↓
BookingController.showAddForm()
    ↓
加载客户列表、房间列表
    ↓
显示booking-add.jsp
    ↓
用户选择客户、房间、日期
    ↓
BookingController.saveBooking()
    ↓
参数验证
    - 客户ID、房间ID非空
    - 入住日期 < 退房日期
    - 入住日期 >= 当前日期
    ↓
调用BookingService.createBooking()
    ↓
业务验证
    - 房间是否可用
    - 日期是否有冲突
    ↓
计算总价
    - 获取房间类型和价格
    - 获取客户VIP等级
    - 选择价格计算策略
    - PriceCalculator.calculate()
    ↓
BookingDAO.insert()
    ↓
更新房间状态为BOOKED
    ↓
事务提交
    ↓
返回预订成功
    ↓
重定向到预订列表
```

## 4. 安全架构

### 4.1 认证机制
- 基于Session的身份认证
- 密码MD5加密存储
- 登录超时自动退出

### 4.2 授权机制
- 基于角色的访问控制(RBAC)
- Filter拦截未授权访问
- 管理员和员工权限分离

### 4.3 数据安全
- SQL注入防护（PreparedStatement）
- XSS攻击防护（输入输出转义）
- CSRF防护（Token验证）

### 4.4 通信安全
- UTF-8字符编码统一
- HTTP头安全配置
- Session安全配置

## 5. 性能架构

### 5.1 数据库层面
- **连接池**: 自定义连接池，复用连接
- **PreparedStatement**: 预编译SQL，提高性能
- **索引优化**: 主键、唯一索引、普通索引
- **查询优化**: 避免SELECT *，使用分页

### 5.2 应用层面
- **对象复用**: 工厂模式创建对象
- **延迟加载**: 按需加载数据
- **缓存机制**: Session缓存用户信息
- **异步处理**: AJAX异步请求

### 5.3 前端层面
- **静态资源**: CDN加速
- **代码压缩**: CSS/JS压缩
- **浏览器缓存**: 设置缓存头
- **分页展示**: 减少单次加载量

## 6. 可扩展性设计

### 6.1 水平扩展
- 无状态设计（可部署多实例）
- 负载均衡支持
- Session共享机制

### 6.2 垂直扩展
- 分层架构便于独立优化
- 接口定义便于替换实现
- 配置外部化

### 6.3 功能扩展
- 工厂模式便于添加新模块
- 策略模式便于添加新算法
- 观察者模式便于添加新监听器

## 7. 异常处理架构

### 7.1 异常分层

```
表现层异常
    ↓ 捕获并友好提示
控制层异常
    ↓ 统一处理和日志记录
业务层异常
    ↓ 业务异常转换
数据层异常
    ↓ SQLException处理
```

### 7.2 日志策略
- **DEBUG**: 开发调试信息
- **INFO**: 关键操作信息
- **WARN**: 警告信息
- **ERROR**: 错误信息

### 7.3 错误响应
- **JSON格式**: {"success": false, "message": "错误信息", "code": 错误码}
- **页面跳转**: 错误页面展示
- **用户提示**: 友好的错误消息

## 8. 架构优势总结

1. **可维护性**: 分层清晰，职责明确
2. **可扩展性**: 设计模式应用，易于扩展
3. **可测试性**: 接口抽象，便于单元测试
4. **可复用性**: 公共组件抽取，减少重复
5. **安全性**: 多层防护，保障系统安全
6. **性能**: 连接池、缓存、索引优化
