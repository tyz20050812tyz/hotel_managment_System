# 数据库设计文档

## 1. 数据库概述

### 1.1 基本信息
- **数据库名称**: hotel_management
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci
- **数据库引擎**: InnoDB
- **MySQL版本**: 8.0+

### 1.2 设计原则
- 符合第三范式(3NF)
- 合理使用外键约束
- 建立必要的索引
- 使用枚举类型管理状态
- 时间戳记录创建和更新时间

## 2. 数据表设计

### 2.1 用户表 (users)

**表说明**: 存储系统用户信息，包括管理员和普通员工

| 字段名 | 数据类型 | 长度 | 是否null | 默认值 | 说明 |
|--------|---------|------|----------|--------|------|
| user_id | INT | - | NOT NULL | AUTO_INCREMENT | 用户ID(主键) |
| username | VARCHAR | 50 | NOT NULL | - | 用户名(唯一) |
| password | VARCHAR | 100 | NOT NULL | - | 密码(MD5加密) |
| real_name | VARCHAR | 50 | NULL | NULL | 真实姓名 |
| role | ENUM | - | NOT NULL | 'STAFF' | 角色(ADMIN/STAFF) |
| email | VARCHAR | 100 | NULL | NULL | 邮箱 |
| phone | VARCHAR | 20 | NULL | NULL | 联系电话 |
| status | ENUM | - | NOT NULL | 'ACTIVE' | 状态(ACTIVE/INACTIVE) |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引设计**:
- PRIMARY KEY: user_id
- UNIQUE KEY: username
- INDEX: status

**示例数据**:
```sql
INSERT INTO users (username, password, real_name, role) VALUES
('admin', MD5('admin'), '系统管理员', 'ADMIN'),
('staff001', MD5('hello'), '张三', 'STAFF');
```

---

### 2.2 客户表 (customers)

**表说明**: 存储酒店客户信息

| 字段名 | 数据类型 | 长度 | 是否null | 默认值 | 说明 |
|--------|---------|------|----------|--------|------|
| customer_id | INT | - | NOT NULL | AUTO_INCREMENT | 客户ID(主键) |
| name | VARCHAR | 100 | NOT NULL | - | 客户姓名 |
| phone | VARCHAR | 20 | NOT NULL | - | 手机号(唯一) |
| email | VARCHAR | 100 | NULL | NULL | 邮箱 |
| id_card | VARCHAR | 18 | NOT NULL | - | 身份证号(唯一) |
| address | VARCHAR | 200 | NULL | NULL | 联系地址 |
| vip_level | INT | - | NOT NULL | 0 | VIP等级(0-5) |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引设计**:
- PRIMARY KEY: customer_id
- UNIQUE KEY: phone
- UNIQUE KEY: id_card
- INDEX: vip_level
- INDEX: created_at

**VIP等级说明**:
- 0: 普通客户 (无折扣)
- 1: 铜卡会员 (9.5折)
- 2: 银卡会员 (9折)
- 3: 金卡会员 (8.5折)
- 4: 白金会员 (8折)
- 5: 钻石会员 (7.5折)

**示例数据**:
```sql
INSERT INTO customers (name, phone, email, id_card, vip_level) VALUES
('张三', '13800138000', 'zhangsan@example.com', '110101199001011234', 1),
('李四', '13900139000', 'lisi@example.com', '110101199002021234', 2);
```

---

### 2.3 房间类型表 (room_types)

**表说明**: 定义不同的房间类型及其属性

| 字段名 | 数据类型 | 长度 | 是否null | 默认值 | 说明 |
|--------|---------|------|----------|--------|------|
| type_id | INT | - | NOT NULL | AUTO_INCREMENT | 类型ID(主键) |
| type_name | VARCHAR | 50 | NOT NULL | - | 类型名称(唯一) |
| price | DECIMAL | 10,2 | NOT NULL | - | 基础价格(元/天) |
| bed_count | INT | - | NOT NULL | 1 | 床位数 |
| max_guests | INT | - | NOT NULL | 1 | 最大容纳人数 |
| description | TEXT | - | NULL | NULL | 类型描述 |
| amenities | VARCHAR | 500 | NULL | NULL | 设施列表(逗号分隔) |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引设计**:
- PRIMARY KEY: type_id
- UNIQUE KEY: type_name
- INDEX: price

**示例数据**:
```sql
INSERT INTO room_types (type_name, price, bed_count, max_guests, description, amenities) VALUES
('标准单人间', 200.00, 1, 1, '配有单人床的标准房间', '免费WiFi,空调,电视,独立卫浴'),
('标准双人间', 280.00, 1, 2, '配有双人床的标准房间', '免费WiFi,空调,电视,独立卫浴'),
('豪华套房', 580.00, 2, 4, '豪华套房,配有客厅和卧室', '免费WiFi,空调,电视,独立卫浴,小吧台');
```

---

### 2.4 房间表 (rooms)

**表说明**: 存储具体房间信息

| 字段名 | 数据类型 | 长度 | 是否null | 默认值 | 说明 |
|--------|---------|------|----------|--------|------|
| room_id | INT | - | NOT NULL | AUTO_INCREMENT | 房间ID(主键) |
| room_number | VARCHAR | 10 | NOT NULL | - | 房间号(唯一) |
| type_id | INT | - | NOT NULL | - | 房间类型ID(外键) |
| floor | INT | - | NOT NULL | 1 | 楼层 |
| status | ENUM | - | NOT NULL | 'AVAILABLE' | 状态 |
| description | VARCHAR | 200 | NULL | NULL | 房间描述 |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**房间状态 (status)**:
- AVAILABLE: 空闲可用
- BOOKED: 已预订
- OCCUPIED: 入住中
- MAINTENANCE: 维护中

**索引设计**:
- PRIMARY KEY: room_id
- UNIQUE KEY: room_number
- FOREIGN KEY: type_id REFERENCES room_types(type_id)
- INDEX: status
- INDEX: floor

**示例数据**:
```sql
INSERT INTO rooms (room_number, type_id, floor, status) VALUES
('101', 1, 1, 'AVAILABLE'),
('102', 1, 1, 'AVAILABLE'),
('201', 2, 2, 'AVAILABLE'),
('301', 3, 3, 'AVAILABLE');
```

---

### 2.5 预订表 (bookings)

**表说明**: 存储客户预订和入住信息

| 字段名 | 数据类型 | 长度 | 是否null | 默认值 | 说明 |
|--------|---------|------|----------|--------|------|
| booking_id | INT | - | NOT NULL | AUTO_INCREMENT | 预订ID(主键) |
| customer_id | INT | - | NOT NULL | - | 客户ID(外键) |
| room_id | INT | - | NOT NULL | - | 房间ID(外键) |
| check_in_date | DATE | - | NOT NULL | - | 入住日期 |
| check_out_date | DATE | - | NOT NULL | - | 退房日期 |
| actual_check_in | TIMESTAMP | - | NULL | NULL | 实际入住时间 |
| actual_check_out | TIMESTAMP | - | NULL | NULL | 实际退房时间 |
| total_price | DECIMAL | 10,2 | NOT NULL | 0.00 | 总价 |
| status | ENUM | - | NOT NULL | 'PENDING' | 预订状态 |
| special_requests | TEXT | - | NULL | NULL | 特殊要求 |
| created_by | INT | - | NOT NULL | - | 创建人ID(外键) |
| created_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**预订状态 (status)**:
- PENDING: 待确认
- CONFIRMED: 已确认
- CHECKED_IN: 已入住
- CHECKED_OUT: 已退房
- CANCELLED: 已取消

**索引设计**:
- PRIMARY KEY: booking_id
- FOREIGN KEY: customer_id REFERENCES customers(customer_id)
- FOREIGN KEY: room_id REFERENCES rooms(room_id)
- FOREIGN KEY: created_by REFERENCES users(user_id)
- INDEX: status
- INDEX: check_in_date
- INDEX: check_out_date
- INDEX: created_at

**示例数据**:
```sql
INSERT INTO bookings (customer_id, room_id, check_in_date, check_out_date, total_price, status, created_by) VALUES
(1, 1, '2025-10-15', '2025-10-17', 400.00, 'CONFIRMED', 1),
(2, 2, '2025-10-16', '2025-10-18', 560.00, 'PENDING', 1);
```

## 3. 数据库关系图 (E-R图)

```
erDiagram
    users {
        int user_id PK "AUTO_INCREMENT"
        varchar username UK "UNIQUE, 用户名"
        varchar password "密码(MD5加密)"
        varchar real_name "真实姓名"
        enum role "角色(ADMIN/STAFF)"
        varchar email "邮箱"
        varchar phone "联系电话"
        enum status "状态(ACTIVE/INACTIVE)"
        timestamp created_at "创建时间"
        timestamp updated_at "更新时间"
    }
    
    customers {
        int customer_id PK "AUTO_INCREMENT"
        varchar name "客户姓名"
        varchar phone UK "手机号(唯一)"
        varchar email "邮箱"
        varchar id_card UK "身份证号(唯一)"
        varchar address "联系地址"
        int vip_level "VIP等级(0-5)"
        timestamp created_at "创建时间"
        timestamp updated_at "更新时间"
    }
    
    room_types {
        int type_id PK "AUTO_INCREMENT"
        varchar type_name UK "类型名称(唯一)"
        decimal price "基础价格(元/天)"
        int bed_count "床位数"
        int max_guests "最大容纳人数"
        text description "类型描述"
        varchar amenities "设施列表"
        timestamp created_at "创建时间"
        timestamp updated_at "更新时间"
    }
    
    rooms {
        int room_id PK "AUTO_INCREMENT"
        varchar room_number UK "房间号(唯一)"
        int type_id FK "房间类型ID"
        int floor "楼层"
        enum status "状态(AVAILABLE/BOOKED/OCCUPIED/MAINTENANCE)"
        varchar description "房间描述"
        timestamp created_at "创建时间"
        timestamp updated_at "更新时间"
    }
    
    bookings {
        int booking_id PK "AUTO_INCREMENT"
        int customer_id FK "客户ID"
        int room_id FK "房间ID"
        date check_in_date "计划入住日期"
        date check_out_date "计划退房日期"
        timestamp actual_check_in "实际入住时间"
        timestamp actual_check_out "实际退房时间"
        decimal total_price "总价"
        enum status "预订状态(PENDING/CONFIRMED/CHECKED_IN/CHECKED_OUT/CANCELLED)"
        text special_requests "特殊要求"
        int created_by FK "创建人用户ID"
        timestamp created_at "创建时间"
        timestamp updated_at "更新时间"
    }
    
    %% 关系定义
    users ||--o{ bookings : "创建(creates)"
    customers ||--o{ bookings : "预订(makes)"
    rooms ||--o{ bookings : "包含(contains)"
    room_types ||--o{ rooms : "分类(categorizes)"
    
    %% 外键关系
    bookings }|--|| users : "created_by"
    bookings }|--|| customers : "customer_id"
    bookings }|--|| rooms : "room_id"
    rooms }|--|| room_types : "type_id"
```

## 4. 数据约束和业务规则

### 4.1 唯一性约束
- 用户名必须唯一
- 客户手机号必须唯一
- 客户身份证号必须唯一
- 房间号必须唯一
- 房间类型名称必须唯一

### 4.2 外键约束
- bookings.customer_id → customers.customer_id
- bookings.room_id → rooms.room_id
- bookings.created_by → users.user_id
- rooms.type_id → room_types.type_id

### 4.3 业务规则
1. **预订日期规则**:
   - check_out_date 必须大于 check_in_date
   - check_in_date 不能早于当前日期

2. **房间状态规则**:
   - 只有AVAILABLE状态的房间可以预订
   - 入住时房间状态变为OCCUPIED
   - 退房时房间状态变为AVAILABLE

3. **预订状态流转**:
   - PENDING → CONFIRMED → CHECKED_IN → CHECKED_OUT
   - 任何状态都可以 → CANCELLED

4. **价格计算规则**:
   - 总价 = 房间单价 × 天数 × VIP折扣
   - 天数 = check_out_date - check_in_date

## 5. 索引优化策略

### 5.1 主键索引
所有表都有自增主键，InnoDB自动创建聚簇索引

### 5.2 唯一索引
- users.username
- customers.phone
- customers.id_card
- rooms.room_number
- room_types.type_name

### 5.3 普通索引
- users.status - 用于筛选活跃用户
- customers.vip_level - 用于VIP客户查询
- rooms.status - 用于查找可用房间
- rooms.floor - 用于按楼层查询
- bookings.status - 用于查询不同状态的预订
- bookings.check_in_date - 用于查询入住日期
- bookings.check_out_date - 用于查询退房日期

### 5.4 外键索引
外键字段自动创建索引，提高关联查询性能

## 6. SQL查询示例

### 6.1 查询今日入住订单
```sql
SELECT b.*, c.name as customer_name, r.room_number
FROM bookings b
JOIN customers c ON b.customer_id = c.customer_id
JOIN rooms r ON b.room_id = r.room_id
WHERE DATE(b.check_in_date) = CURDATE()
  AND b.status = 'CONFIRMED'
ORDER BY b.check_in_date;
```

### 6.2 查询空闲房间
```sql
SELECT r.*, rt.type_name, rt.price
FROM rooms r
JOIN room_types rt ON r.type_id = rt.type_id
WHERE r.status = 'AVAILABLE'
ORDER BY r.room_number;
```

### 6.3 计算房间入住率
```sql
SELECT 
    COUNT(CASE WHEN status = 'OCCUPIED' THEN 1 END) as occupied_rooms,
    COUNT(*) as total_rooms,
    ROUND(COUNT(CASE WHEN status = 'OCCUPIED' THEN 1 END) * 100.0 / COUNT(*), 2) as occupancy_rate
FROM rooms
WHERE status != 'MAINTENANCE';
```

### 6.4 查询客户预订历史
```sql
SELECT b.*, r.room_number, rt.type_name
FROM bookings b
JOIN rooms r ON b.room_id = r.room_id
JOIN room_types rt ON r.type_id = rt.type_id
WHERE b.customer_id = ?
ORDER BY b.created_at DESC;
```

## 7. 数据库维护

### 7.1 备份策略
- 每日全量备份
- 使用mysqldump工具
- 保留最近7天的备份

### 7.2 性能监控
- 定期检查慢查询日志
- 监控索引使用情况
- 优化高频查询

### 7.3 数据清理
- 定期归档历史预订数据（保留1年内数据）
- 清理已取消的预订记录（保留3个月）
