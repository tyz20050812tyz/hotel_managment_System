# é…’åº—ç®¡ç†ç³»ç»Ÿ - å·¥å…·ç±»è¯¦è§£

## ğŸ“‹ ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [å·¥å…·ç±»æ¶æ„](#å·¥å…·ç±»æ¶æ„)
3. [æ ¸å¿ƒå·¥å…·ç±»è¯¦è§£](#æ ¸å¿ƒå·¥å…·ç±»è¯¦è§£)
4. [è¿‡æ»¤å™¨è¯¦è§£](#è¿‡æ»¤å™¨è¯¦è§£)
5. [è®¾è®¡æ¨¡å¼åº”ç”¨](#è®¾è®¡æ¨¡å¼åº”ç”¨)
6. [å·¥å…·ç±»UMLå›¾](#å·¥å…·ç±»umlå›¾)

---

## ğŸ“– æ¦‚è¿°

æœ¬ç³»ç»Ÿçš„å·¥å…·ç±»(`util`åŒ…)å’Œè¿‡æ»¤å™¨(`filter`åŒ…)æä¾›äº†ç³»ç»ŸåŸºç¡€åŠŸèƒ½æ”¯æŒï¼ŒåŒ…æ‹¬é…ç½®ç®¡ç†ã€æ•°æ®åº“è¿æ¥æ± ã€å¯†ç åŠ å¯†ã€æ•°æ®éªŒè¯ã€å­—ç¬¦ç¼–ç å¤„ç†å’Œç™»å½•éªŒè¯ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### æŠ€æœ¯ç‰¹ç‚¹
- **å•ä¾‹æ¨¡å¼**ï¼šé…ç½®ç®¡ç†å™¨å’Œè¿æ¥æ± ç®¡ç†
- **å·¥å‚æ¨¡å¼**ï¼šè¿æ¥æ± åˆ›å»º
- **åŠ å¯†å®‰å…¨**ï¼šMD5å¯†ç åŠ å¯†
- **æ•°æ®éªŒè¯**ï¼šèº«ä»½è¯ã€æ‰‹æœºå·ã€é‚®ç®±æ ¼å¼éªŒè¯
- **è¿‡æ»¤å™¨é“¾**ï¼šç»Ÿä¸€çš„è¯·æ±‚å¤„ç†

---

## ğŸ—ï¸ å·¥å…·ç±»æ¶æ„

```mermaid
graph TB
    subgraph "å·¥å…·ç±»åŒ… (util)"
        CM[ConfigManager<br/>é…ç½®ç®¡ç†å™¨]
        CP[ConnectionPool<br/>è¿æ¥æ± ç®¡ç†]
        PU[PasswordUtil<br/>å¯†ç å·¥å…·]
        U[Utils<br/>é€šç”¨å·¥å…·]
    end
    
    subgraph "è¿‡æ»¤å™¨åŒ… (filter)"
        CEF[CharacterEncodingFilter<br/>å­—ç¬¦ç¼–ç è¿‡æ»¤å™¨]
        LF[LoginFilter<br/>ç™»å½•éªŒè¯è¿‡æ»¤å™¨]
    end
    
    subgraph "é…ç½®æ–‡ä»¶"
        DB[db.properties<br/>æ•°æ®åº“é…ç½®]
    end
    
    subgraph "å¤–éƒ¨ä¾èµ–"
        Druid[Druidè¿æ¥æ± ]
        Log4j[Log4j2æ—¥å¿—]
        MD5[MD5åŠ å¯†]
    end
    
    CM --> DB
    CP --> CM
    CP --> Druid
    CP --> Log4j
    PU --> MD5
    
    CEF --> LF
    LF --> Log4j
```

---

## ğŸ”§ æ ¸å¿ƒå·¥å…·ç±»è¯¦è§£

### 1. ConfigManager - é…ç½®ç®¡ç†å™¨

**ä½œç”¨**ï¼šä½¿ç”¨å•ä¾‹æ¨¡å¼ç®¡ç†åº”ç”¨ç¨‹åºé…ç½®ï¼Œæ”¯æŒå¤šç§æ•°æ®ç±»å‹çš„é…ç½®è¯»å–ã€‚

**è®¾è®¡æ¨¡å¼**ï¼šå•ä¾‹æ¨¡å¼ï¼ˆåŒé‡é”å®šæ£€æŸ¥ï¼‰

#### å…³é”®ç‰¹æ€§

```java
public class ConfigManager {
    private static volatile ConfigManager instance;
    private Properties properties;
    
    // åŒé‡é”å®šæ£€æŸ¥çš„å•ä¾‹å®ç°
    public static ConfigManager getInstance() {
        if (instance == null) {
            synchronized (ConfigManager.class) {
                if (instance == null) {
                    instance = new ConfigManager();
                }
            }
        }
        return instance;
    }
}
```

#### æ ¸å¿ƒåŠŸèƒ½

1. **é…ç½®æ–‡ä»¶åŠ è½½**
   ```java
   private void loadPropertiesFile(String fileName) {
       InputStream inputStream = ConfigManager.class.getClassLoader()
           .getResourceAsStream(fileName);
       if (inputStream != null) {
           Properties tempProps = new Properties();
           tempProps.load(inputStream);
           properties.putAll(tempProps);
       }
   }
   ```

2. **ç±»å‹å®‰å…¨çš„é…ç½®è¯»å–**
   ```java
   public int getInt(String key, int defaultValue) {
       String value = properties.getProperty(key);
       if (value != null) {
           try {
               return Integer.parseInt(value.trim());
           } catch (NumberFormatException e) {
               logger.warn("Invalid integer value for key {}: {}", key, value);
           }
       }
       return defaultValue;
   }
   ```

3. **æ•°æ®åº“é…ç½®ä¾¿æ·æ–¹æ³•**
   ```java
   public String getDbDriver() { return getString("db.driver"); }
   public String getDbUrl() { return getString("db.url"); }
   public int getDbMaxActive() { return getInt("db.maxActive", 20); }
   ```

#### é…ç½®ç®¡ç†æµç¨‹

```mermaid
flowchart TD
    A[åº”ç”¨å¯åŠ¨] --> B[ConfigManager.getInstance()]
    B --> C{å®ä¾‹æ˜¯å¦å­˜åœ¨?}
    C -->|å¦| D[åˆ›å»ºæ–°å®ä¾‹]
    C -->|æ˜¯| E[è¿”å›ç°æœ‰å®ä¾‹]
    D --> F[åŠ è½½db.properties]
    F --> G[åˆå§‹åŒ–Properties]
    G --> H[è®°å½•æ—¥å¿—]
    H --> E
    E --> I[æä¾›é…ç½®è®¿é—®æ–¹æ³•]
```

---

### 2. ConnectionPool - æ•°æ®åº“è¿æ¥æ± 

**ä½œç”¨**ï¼šä½¿ç”¨Druidè¿æ¥æ± ç®¡ç†æ•°æ®åº“è¿æ¥ï¼Œæä¾›é«˜æ€§èƒ½çš„è¿æ¥å¤ç”¨ã€‚

**è®¾è®¡æ¨¡å¼**ï¼šå•ä¾‹æ¨¡å¼ + å·¥å‚æ¨¡å¼

#### å…³é”®ç‰¹æ€§

```java
public class ConnectionPool {
    private static volatile ConnectionPool instance;
    private DataSource dataSource;
    
    private void initDataSource() {
        Properties properties = new Properties();
        // è¯»å–é…ç½®æ–‡ä»¶
        inputStream = ConnectionPool.class.getClassLoader()
                .getResourceAsStream("db.properties");
        properties.load(inputStream);
        
        // ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºæ•°æ®æº
        dataSource = DruidDataSourceFactory.createDataSource(properties);
    }
}
```

#### æ ¸å¿ƒåŠŸèƒ½

1. **è¿æ¥è·å–**
   ```java
   public Connection getConnection() throws SQLException {
       try {
           Connection connection = dataSource.getConnection();
           logger.debug("Database connection obtained");
           return connection;
       } catch (SQLException e) {
           logger.error("Failed to get database connection", e);
           throw e;
       }
   }
   ```

2. **è¿æ¥æ± ç›‘æ§**
   ```java
   public String getPoolStatus() {
       if (dataSource instanceof DruidDataSource) {
           DruidDataSource druidDataSource = (DruidDataSource) dataSource;
           StringBuilder status = new StringBuilder();
           status.append("Active Connections: ").append(druidDataSource.getActiveCount());
           status.append("Pool Size: ").append(druidDataSource.getPoolingCount());
           return status.toString();
       }
       return "Connection pool status not available";
   }
   ```

3. **è¿æ¥æµ‹è¯•**
   ```java
   public boolean testConnection() {
       try (Connection connection = getConnection()) {
           boolean isValid = connection.isValid(5); // 5ç§’è¶…æ—¶
           return isValid;
       } catch (SQLException e) {
           logger.error("Database connection test failed", e);
           return false;
       }
   }
   ```

#### è¿æ¥æ± å·¥ä½œæµç¨‹

```mermaid
sequenceDiagram
    participant App as åº”ç”¨ç¨‹åº
    participant CP as ConnectionPool
    participant DS as DataSource
    participant DB as æ•°æ®åº“
    
    App->>CP: getInstance()
    CP->>DS: åˆå§‹åŒ–Druidæ•°æ®æº
    DS->>DB: åˆ›å»ºåˆå§‹è¿æ¥
    App->>CP: getConnection()
    CP->>DS: ä»è¿æ¥æ± è·å–è¿æ¥
    DS-->>CP: è¿”å›å¯ç”¨è¿æ¥
    CP-->>App: è¿”å›æ•°æ®åº“è¿æ¥
    App->>DB: æ‰§è¡ŒSQLæ“ä½œ
    App->>CP: å…³é—­è¿æ¥(å®é™…å½’è¿˜åˆ°æ± )
    CP->>DS: è¿æ¥å›æ”¶åˆ°æ± ä¸­
```

---

### 3. PasswordUtil - å¯†ç å·¥å…·ç±»

**ä½œç”¨**ï¼šæä¾›å¯†ç åŠ å¯†ã€éªŒè¯ã€å¼ºåº¦æ£€æŸ¥å’Œéšæœºå¯†ç ç”ŸæˆåŠŸèƒ½ã€‚

#### æ ¸å¿ƒåŠŸèƒ½

1. **MD5å¯†ç åŠ å¯†**
   ```java
   public static String encrypt(String password) {
       try {
           MessageDigest md = MessageDigest.getInstance("MD5");
           byte[] bytes = md.digest(password.getBytes("UTF-8"));
           return bytesToHex(bytes);
       } catch (Exception e) {
           throw new RuntimeException("Password encryption failed", e);
       }
   }
   ```

2. **å¯†ç éªŒè¯**
   ```java
   public static boolean verify(String password, String encryptedPassword) {
       if (password == null || encryptedPassword == null) {
           return false;
       }
       String encrypted = encrypt(password);
       return encrypted.equals(encryptedPassword);
   }
   ```

3. **å¯†ç å¼ºåº¦æ£€æŸ¥**
   ```java
   public static int checkPasswordStrength(String password) {
       boolean hasLower = password.matches(".*[a-z].*");
       boolean hasUpper = password.matches(".*[A-Z].*");
       boolean hasDigit = password.matches(".*[0-9].*");
       boolean hasSpecial = password.matches(".*[!@#$%^&*()_+...].*");
       
       int score = 1; // åŸºç¡€åˆ†æ•°
       if (password.length() >= 8) score++;
       if (hasUpper) score++;
       if (hasDigit) score++;
       if (hasSpecial) score++;
       
       return Math.min(score, 5);
   }
   ```

4. **éšæœºå¯†ç ç”Ÿæˆ**
   ```java
   public static String generateRandomPassword(int length) {
       String chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
       SecureRandom random = new SecureRandom();
       StringBuilder sb = new StringBuilder();
       
       for (int i = 0; i < length; i++) {
           sb.append(chars.charAt(random.nextInt(chars.length())));
       }
       return sb.toString();
   }
   ```

#### å¯†ç å¤„ç†æµç¨‹

```mermaid
flowchart TD
    A[ç”¨æˆ·è¾“å…¥å¯†ç ] --> B[å¯†ç å¼ºåº¦æ£€æŸ¥]
    B --> C{å¼ºåº¦æ˜¯å¦è¶³å¤Ÿ?}
    C -->|å¦| D[æç¤ºç”¨æˆ·å¢å¼ºå¯†ç ]
    C -->|æ˜¯| E[MD5åŠ å¯†]
    E --> F[å­˜å‚¨åˆ°æ•°æ®åº“]
    
    G[ç”¨æˆ·ç™»å½•] --> H[è¾“å…¥å¯†ç ]
    H --> I[MD5åŠ å¯†è¾“å…¥å¯†ç ]
    I --> J[ä¸æ•°æ®åº“å¯†ç æ¯”è¾ƒ]
    J --> K{å¯†ç åŒ¹é…?}
    K -->|æ˜¯| L[ç™»å½•æˆåŠŸ]
    K -->|å¦| M[ç™»å½•å¤±è´¥]
```

---

### 4. Utils - é€šç”¨å·¥å…·ç±»

**ä½œç”¨**ï¼šæä¾›æ•°æ®éªŒè¯ã€æ ¼å¼åŒ–ç­‰é€šç”¨åŠŸèƒ½ã€‚

#### æ ¸å¿ƒåŠŸèƒ½

1. **èº«ä»½è¯å·éªŒè¯**
   ```java
   public static boolean validateIdCard(String idCard) {
       // åŸºæœ¬æ ¼å¼éªŒè¯
       if (!ID_CARD_PATTERN.matcher(trimmedIdCard).matches()) {
           return false;
       }
       // æ ¡éªŒç éªŒè¯
       return validateIdCardChecksum(trimmedIdCard);
   }
   
   private static boolean validateIdCardChecksum(String idCard) {
       int[] weights = {7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2};
       char[] checkCodes = {'1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'};
       
       int sum = 0;
       for (int i = 0; i < 17; i++) {
           sum += (idCard.charAt(i) - '0') * weights[i];
       }
       
       int remainder = sum % 11;
       char expectedCheckCode = checkCodes[remainder];
       char actualCheckCode = Character.toUpperCase(idCard.charAt(17));
       
       return expectedCheckCode == actualCheckCode;
   }
   ```

2. **æ‰‹æœºå·å’Œé‚®ç®±éªŒè¯**
   ```java
   private static final Pattern PHONE_PATTERN = 
       Pattern.compile("^1[3-9]\\d{9}$");
   
   private static final Pattern EMAIL_PATTERN = 
       Pattern.compile("^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$");
   
   public static boolean validatePhone(String phone) {
       return phone != null && PHONE_PATTERN.matcher(phone.trim()).matches();
   }
   ```

3. **æ•°æ®æ ¼å¼åŒ–**
   ```java
   public static String formatPhone(String phone) {
       if (validatePhone(phone) && phone.trim().length() == 11) {
           String trimmedPhone = phone.trim();
           return trimmedPhone.substring(0, 3) + "****" + trimmedPhone.substring(7);
       }
       return phone;
   }
   
   public static String formatIdCard(String idCard) {
       if (validateIdCard(idCard) && idCard.trim().length() == 18) {
           String trimmedIdCard = idCard.trim();
           return trimmedIdCard.substring(0, 6) + "********" + trimmedIdCard.substring(14);
       }
       return idCard;
   }
   ```

---

## ğŸ” è¿‡æ»¤å™¨è¯¦è§£

### 1. CharacterEncodingFilter - å­—ç¬¦ç¼–ç è¿‡æ»¤å™¨

**ä½œç”¨**ï¼šç»Ÿä¸€è®¾ç½®è¯·æ±‚å’Œå“åº”çš„å­—ç¬¦ç¼–ç ä¸ºUTF-8ï¼Œè§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜ã€‚

#### æ ¸å¿ƒå®ç°

```java
@Override
public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
        throws IOException, ServletException {
    
    HttpServletRequest httpRequest = (HttpServletRequest) request;
    HttpServletResponse httpResponse = (HttpServletResponse) response;
    
    // è®¾ç½®è¯·æ±‚ç¼–ç 
    if (forceEncoding || httpRequest.getCharacterEncoding() == null) {
        httpRequest.setCharacterEncoding(encoding);
    }
    
    // è®¾ç½®å“åº”ç¼–ç 
    if (forceEncoding || httpResponse.getCharacterEncoding() == null || 
        "ISO-8859-1".equals(httpResponse.getCharacterEncoding())) {
        httpResponse.setCharacterEncoding(encoding);
    }
    
    chain.doFilter(request, response);
}
```

### 2. LoginFilter - ç™»å½•éªŒè¯è¿‡æ»¤å™¨

**ä½œç”¨**ï¼šæ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œæœªç™»å½•ç”¨æˆ·é‡å®šå‘åˆ°ç™»å½•é¡µé¢ã€‚

#### æ ¸å¿ƒåŠŸèƒ½

1. **URLæ’é™¤æœºåˆ¶**
   ```java
   private static final List<String> EXCLUDE_URLS = Arrays.asList(
       "/login.jsp", "/login", "/css/", "/js/", "/images/", "/favicon.ico"
   );
   
   private boolean isExcludedUrl(String path) {
       for (String excludeUrl : EXCLUDE_URLS) {
           if (path.startsWith(excludeUrl)) {
               return true;
           }
       }
       return false;
   }
   ```

2. **ç™»å½•çŠ¶æ€æ£€æŸ¥**
   ```java
   HttpSession session = httpRequest.getSession(false);
   User user = null;
   if (session != null) {
       user = (User) session.getAttribute("user");
   }
   
   if (user == null) {
       // ç”¨æˆ·æœªç™»å½•ï¼Œå¤„ç†é‡å®šå‘
       handleUnauthorizedAccess(httpRequest, httpResponse);
       return;
   }
   ```

3. **AJAXè¯·æ±‚æ”¯æŒ**
   ```java
   private boolean isAjaxRequest(HttpServletRequest request) {
       String requestedWith = request.getHeader("X-Requested-With");
       return "XMLHttpRequest".equals(requestedWith);
   }
   
   if (isAjaxRequest(httpRequest)) {
       httpResponse.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
       httpResponse.setContentType("application/json;charset=UTF-8");
       httpResponse.getWriter().write(
           "{\"success\":false,\"message\":\"ç”¨æˆ·æœªç™»å½•\",\"code\":401}"
       );
       return;
   }
   ```

#### è¿‡æ»¤å™¨æ‰§è¡Œæµç¨‹

```mermaid
flowchart TD
    A[HTTPè¯·æ±‚] --> B[CharacterEncodingFilter]
    B --> C[è®¾ç½®UTF-8ç¼–ç ]
    C --> D[LoginFilter]
    D --> E{URLæ˜¯å¦åœ¨æ’é™¤åˆ—è¡¨?}
    E -->|æ˜¯| F[ç›´æ¥æ”¾è¡Œ]
    E -->|å¦| G{ç”¨æˆ·æ˜¯å¦å·²ç™»å½•?}
    G -->|æ˜¯| F
    G -->|å¦| H{æ˜¯å¦AJAXè¯·æ±‚?}
    H -->|æ˜¯| I[è¿”å›JSONé”™è¯¯]
    H -->|å¦| J[é‡å®šå‘åˆ°ç™»å½•é¡µ]
    F --> K[ç»§ç»­å¤„ç†è¯·æ±‚]
    I --> L[ç»“æŸè¯·æ±‚]
    J --> L
```

---

## ğŸ¯ è®¾è®¡æ¨¡å¼åº”ç”¨

### 1. å•ä¾‹æ¨¡å¼
- **ConfigManager**ï¼šå…¨å±€å”¯ä¸€çš„é…ç½®ç®¡ç†å™¨
- **ConnectionPool**ï¼šå…¨å±€å”¯ä¸€çš„è¿æ¥æ± ç®¡ç†å™¨
- **å®ç°æ–¹å¼**ï¼šåŒé‡é”å®šæ£€æŸ¥ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨

### 2. å·¥å‚æ¨¡å¼
- **DruidDataSourceFactory**ï¼šåˆ›å»ºæ•°æ®æºå¯¹è±¡
- **å¥½å¤„**ï¼šè§£è€¦å¯¹è±¡åˆ›å»ºå’Œä½¿ç”¨

### 3. è¿‡æ»¤å™¨æ¨¡å¼
- **CharacterEncodingFilter + LoginFilter**ï¼šå½¢æˆè¿‡æ»¤å™¨é“¾
- **å¥½å¤„**ï¼šç»Ÿä¸€çš„è¯·æ±‚é¢„å¤„ç†

---

## ğŸ“Š å·¥å…·ç±»UMLå›¾

```mermaid
classDiagram
    class ConfigManager {
        -static volatile ConfigManager instance
        -Properties properties
        +static getInstance() ConfigManager
        +getString(key) String
        +getInt(key, defaultValue) int
        +getBoolean(key, defaultValue) boolean
        +getDbDriver() String
        +reload() void
    }
    
    class ConnectionPool {
        -static volatile ConnectionPool instance
        -DataSource dataSource
        +static getInstance() ConnectionPool
        +getConnection() Connection
        +getPoolStatus() String
        +testConnection() boolean
        +close() void
    }
    
    class PasswordUtil {
        +static encrypt(password) String
        +static verify(password, encrypted) boolean
        +static generateRandomPassword(length) String
        +static checkPasswordStrength(password) int
    }
    
    class Utils {
        +static validateIdCard(idCard) boolean
        +static validatePhone(phone) boolean
        +static validateEmail(email) boolean
        +static formatPhone(phone) String
        +static formatIdCard(idCard) String
        +static isEmpty(str) boolean
    }
    
    class CharacterEncodingFilter {
        -String encoding
        -boolean forceEncoding
        +init(FilterConfig) void
        +doFilter(request, response, chain) void
        +destroy() void
    }
    
    class LoginFilter {
        -static final List~String~ EXCLUDE_URLS
        +init(FilterConfig) void
        +doFilter(request, response, chain) void
        -isExcludedUrl(path) boolean
        -isAjaxRequest(request) boolean
    }
    
    ConnectionPool --> ConfigManager : ä½¿ç”¨
    LoginFilter --> CharacterEncodingFilter : è¿‡æ»¤å™¨é“¾
```

---

## ğŸ”š æ€»ç»“

å·¥å…·ç±»å’Œè¿‡æ»¤å™¨æ˜¯ç³»ç»Ÿçš„åŸºç¡€è®¾æ–½ï¼Œæä¾›äº†ï¼š

1. **é…ç½®ç®¡ç†**ï¼šç»Ÿä¸€çš„é…ç½®è¯»å–å’Œç®¡ç†
2. **è¿æ¥æ± ç®¡ç†**ï¼šé«˜æ•ˆçš„æ•°æ®åº“è¿æ¥å¤ç”¨
3. **å®‰å…¨æ”¯æŒ**ï¼šå¯†ç åŠ å¯†å’Œæ•°æ®éªŒè¯
4. **é€šç”¨å·¥å…·**ï¼šæ•°æ®æ ¼å¼åŒ–å’ŒéªŒè¯
5. **è¯·æ±‚è¿‡æ»¤**ï¼šç¼–ç ç»Ÿä¸€å’Œç™»å½•éªŒè¯

è¿™äº›ç»„ä»¶é‡‡ç”¨äº†å•ä¾‹æ¨¡å¼ã€å·¥å‚æ¨¡å¼ç­‰è®¾è®¡æ¨¡å¼ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„ç¨³å®šæ€§ã€å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚