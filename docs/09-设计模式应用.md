# é…’åº—ç®¡ç†ç³»ç»Ÿ - è®¾è®¡æ¨¡å¼åº”ç”¨è¯¦è§£

## ğŸ“‹ ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [è®¾è®¡æ¨¡å¼æ€»è§ˆ](#è®¾è®¡æ¨¡å¼æ€»è§ˆ)
3. [å•ä¾‹æ¨¡å¼](#å•ä¾‹æ¨¡å¼)
4. [å·¥å‚æ¨¡å¼](#å·¥å‚æ¨¡å¼)
5. [ç­–ç•¥æ¨¡å¼](#ç­–ç•¥æ¨¡å¼)
6. [æ¨¡æ¿æ–¹æ³•æ¨¡å¼](#æ¨¡æ¿æ–¹æ³•æ¨¡å¼)
7. [DAOæ¨¡å¼](#daoæ¨¡å¼)
8. [è§‚å¯Ÿè€…æ¨¡å¼](#è§‚å¯Ÿè€…æ¨¡å¼)
9. [è®¾è®¡æ¨¡å¼åä½œ](#è®¾è®¡æ¨¡å¼åä½œ)

---

## ğŸ“– æ¦‚è¿°

æœ¬é…’åº—ç®¡ç†ç³»ç»Ÿé‡‡ç”¨äº†6ç§ç»å…¸è®¾è®¡æ¨¡å¼ï¼Œè¿™äº›æ¨¡å¼çš„åˆç†è¿ç”¨ä¸ä»…æé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ï¼Œè¿˜ä½“ç°äº†é¢å‘å¯¹è±¡è®¾è®¡çš„æ ¸å¿ƒæ€æƒ³ã€‚æ¯ä¸ªè®¾è®¡æ¨¡å¼éƒ½è§£å†³äº†ç‰¹å®šçš„è®¾è®¡é—®é¢˜ï¼Œå…±åŒæ„å»ºäº†ä¸€ä¸ªçµæ´»ã€å¥å£®çš„ç³»ç»Ÿæ¶æ„ã€‚

### åº”ç”¨çš„è®¾è®¡æ¨¡å¼
1. **å•ä¾‹æ¨¡å¼** (Singleton) - é…ç½®ç®¡ç†å’Œè¿æ¥æ± 
2. **å·¥å‚æ¨¡å¼** (Factory) - DAOå¯¹è±¡åˆ›å»º
3. **ç­–ç•¥æ¨¡å¼** (Strategy) - ä»·æ ¼è®¡ç®—ç­–ç•¥
4. **æ¨¡æ¿æ–¹æ³•æ¨¡å¼** (Template Method) - é€šç”¨ä¸šåŠ¡æµç¨‹
5. **DAOæ¨¡å¼** (Data Access Object) - æ•°æ®è®¿é—®å°è£…
6. **è§‚å¯Ÿè€…æ¨¡å¼** (Observer) - æ—¥å¿—å’Œäº‹ä»¶å¤„ç†

---

## ğŸ¯ è®¾è®¡æ¨¡å¼æ€»è§ˆ

```mermaid
graph TB
    subgraph "åˆ›å»ºå‹æ¨¡å¼"
        S[å•ä¾‹æ¨¡å¼<br/>Singleton]
        F[å·¥å‚æ¨¡å¼<br/>Factory]
    end
    
    subgraph "ç»“æ„å‹æ¨¡å¼"
        D[DAOæ¨¡å¼<br/>Data Access Object]
        FT[è¿‡æ»¤å™¨æ¨¡å¼<br/>Filter]
    end
    
    subgraph "è¡Œä¸ºå‹æ¨¡å¼"
        ST[ç­–ç•¥æ¨¡å¼<br/>Strategy]
        TM[æ¨¡æ¿æ–¹æ³•æ¨¡å¼<br/>Template Method]
        O[è§‚å¯Ÿè€…æ¨¡å¼<br/>Observer]
    end
    
    subgraph "åº”ç”¨åœºæ™¯"
        Config[é…ç½®ç®¡ç†]
        Pool[è¿æ¥æ± ]
        Price[ä»·æ ¼è®¡ç®—]
        Data[æ•°æ®è®¿é—®]
        Log[æ—¥å¿—å¤„ç†]
        Business[ä¸šåŠ¡æµç¨‹]
        Auth[ç™»å½•éªŒè¯]
        Encoding[å­—ç¬¦ç¼–ç ]
    end
    
    S --> Config
    S --> Pool
    F --> Data
    ST --> Price
    TM --> Business
    D --> Data
    O --> Log
    FT --> Auth
    FT --> Encoding
```

---

## ğŸ”§ å•ä¾‹æ¨¡å¼ (Singleton Pattern)

### è®¾è®¡ç›®çš„
ç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›å…¨å±€è®¿é—®ç‚¹ï¼ŒèŠ‚çº¦ç³»ç»Ÿèµ„æºã€‚

### åº”ç”¨åœºæ™¯
1. **ConfigManager** - é…ç½®ç®¡ç†å™¨
2. **ConnectionPool** - æ•°æ®åº“è¿æ¥æ± 

### å®ç°æ–¹å¼ï¼šåŒé‡é”å®šæ£€æŸ¥ (Double-Checked Locking)

#### ConfigManagerå®ç°
```java
public class ConfigManager {
    // volatileå…³é”®å­—ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å¯è§æ€§
    private static volatile ConfigManager instance;
    private Properties properties;
    
    // ç§æœ‰æ„é€ å‡½æ•°ï¼Œé˜²æ­¢å¤–éƒ¨å®ä¾‹åŒ–
    private ConfigManager() {
        loadConfiguration();
    }
    
    /**
     * è·å–å•ä¾‹å®ä¾‹ï¼ˆåŒé‡é”å®šæ£€æŸ¥ï¼‰
     * @return ConfigManagerå®ä¾‹
     */
    public static ConfigManager getInstance() {
        if (instance == null) {  // ç¬¬ä¸€æ¬¡æ£€æŸ¥
            synchronized (ConfigManager.class) {
                if (instance == null) {  // ç¬¬äºŒæ¬¡æ£€æŸ¥
                    instance = new ConfigManager();
                }
            }
        }
        return instance;
    }
    
    // é…ç½®è®¿é—®æ–¹æ³•
    public String getString(String key) {
        return properties.getProperty(key);
    }
    
    public int getInt(String key, int defaultValue) {
        String value = properties.getProperty(key);
        try {
            return value != null ? Integer.parseInt(value.trim()) : defaultValue;
        } catch (NumberFormatException e) {
            return defaultValue;
        }
    }
}
```

#### ConnectionPoolå®ç°
```java
public class ConnectionPool {
    private static volatile ConnectionPool instance;
    private DataSource dataSource;
    
    private ConnectionPool() {
        initDataSource();
    }
    
    public static ConnectionPool getInstance() {
        if (instance == null) {
            synchronized (ConnectionPool.class) {
                if (instance == null) {
                    instance = new ConnectionPool();
                }
            }
        }
        return instance;
    }
    
    public Connection getConnection() throws SQLException {
        return dataSource.getConnection();
    }
}
```

### å•ä¾‹æ¨¡å¼çš„ä¼˜åŠ¿
1. **å†…å­˜ä¼˜åŒ–**ï¼šåªåˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼ŒèŠ‚çº¦å†…å­˜
2. **èµ„æºæ§åˆ¶**ï¼šç»Ÿä¸€ç®¡ç†å…±äº«èµ„æº
3. **çº¿ç¨‹å®‰å…¨**ï¼šåŒé‡é”å®šæ£€æŸ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨
4. **å»¶è¿Ÿåˆå§‹åŒ–**ï¼šåªæœ‰åœ¨éœ€è¦æ—¶æ‰åˆ›å»ºå®ä¾‹

### å•ä¾‹æ¨¡å¼æµç¨‹å›¾
```mermaid
flowchart TD
    A[è°ƒç”¨getInstance] --> B{instanceä¸ºnull}
    B -- æ˜¯ --> C[è·å–ç±»é”]
    B -- å¦ --> G[è¿”å›ç°æœ‰å®ä¾‹]
    C --> D{å†æ¬¡æ£€æŸ¥instanceä¸ºnull}
    D -- æ˜¯ --> E[åˆ›å»ºæ–°å®ä¾‹]
    D -- å¦ --> F[é‡Šæ”¾é”]
    E --> F
    F --> G
    G --> H[è¿”å›å®ä¾‹]
```

---

## ğŸ­ å·¥å‚æ¨¡å¼ (Factory Pattern)

### è®¾è®¡ç›®çš„
åˆ›å»ºå¯¹è±¡æ—¶ä¸å¿…æŒ‡å®šåˆ›å»ºå¯¹è±¡çš„å…·ä½“ç±»ï¼Œå°†å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨åˆ†ç¦»ã€‚

### åº”ç”¨åœºæ™¯
**DAOFactory** - ç»Ÿä¸€åˆ›å»ºå„ç§DAOå®ç°

### å®ç°æ–¹å¼

#### DAOFactoryå®ç°
```java
public class DAOFactory {
    
    /**
     * è·å–UserDAOå®ä¾‹
     * @return UserDAOå®ä¾‹
     */
    public static UserDAO getUserDAO() {
        return new UserDAOImpl();
    }
    
    /**
     * è·å–CustomerDAOå®ä¾‹
     * @return CustomerDAOå®ä¾‹
     */
    public static CustomerDAO getCustomerDAO() {
        return new CustomerDAOImpl();
    }
    
    /**
     * è·å–RoomDAOå®ä¾‹
     * @return RoomDAOå®ä¾‹
     */
    public static RoomDAO getRoomDAO() {
        return new RoomDAOImpl();
    }
    
    /**
     * è·å–RoomTypeDAOå®ä¾‹
     * @return RoomTypeDAOå®ä¾‹
     */
    public static RoomTypeDAO getRoomTypeDAO() {
        return new RoomTypeDAOImpl();
    }
    
    /**
     * è·å–BookingDAOå®ä¾‹
     * @return BookingDAOå®ä¾‹
     */
    public static BookingDAO getBookingDAO() {
        return new BookingDAOImpl();
    }
}
```

#### Serviceå±‚ä¸­çš„ä½¿ç”¨
```java
public class BookingService {
    private BookingDAO bookingDAO;
    private CustomerDAO customerDAO;
    private RoomDAO roomDAO;
    
    public BookingService() {
        // ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºDAOå®ä¾‹
        this.bookingDAO = DAOFactory.getBookingDAO();
        this.customerDAO = DAOFactory.getCustomerDAO();
        this.roomDAO = DAOFactory.getRoomDAO();
    }
    
    public boolean createBooking(Booking booking) {
        // ä¸šåŠ¡é€»è¾‘å®ç°
        return bookingDAO.save(booking);
    }
}
```

### å·¥å‚æ¨¡å¼çš„ä¼˜åŠ¿
1. **è§£è€¦åˆ**ï¼šå®¢æˆ·ç«¯ä»£ç ä¸å…·ä½“å®ç°åˆ†ç¦»
2. **æ‰©å±•æ€§**ï¼šæ–°å¢DAOå®ç°æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
3. **ç»Ÿä¸€ç®¡ç†**ï¼šé›†ä¸­ç®¡ç†å¯¹è±¡åˆ›å»ºé€»è¾‘
4. **ä»£ç å¤ç”¨**ï¼šé¿å…é‡å¤çš„å¯¹è±¡åˆ›å»ºä»£ç 

### å·¥å‚æ¨¡å¼UMLå›¾
```mermaid
classDiagram
    class DAOFactory {
        +getUserDAO() UserDAO
        +getCustomerDAO() CustomerDAO
        +getRoomDAO() RoomDAO
        +getBookingDAO() BookingDAO
    }
    
    class UserDAO {
        <<interface>>
    }
    
    class UserDAOImpl {
        +save() boolean
        +findById() User
        +findAll() List~User~
    }
    
    class BookingService {
        -bookingDAO: BookingDAO
        +createBooking() boolean
    }
    
    DAOFactory --> UserDAO
    DAOFactory --> UserDAOImpl
    BookingService --> DAOFactory
    UserDAO <|.. UserDAOImpl
```

---

## ğŸ’° ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

### è®¾è®¡ç›®çš„
å®šä¹‰ç®—æ³•æ—ï¼Œåˆ†åˆ«å°è£…èµ·æ¥ï¼Œè®©å®ƒä»¬ä¹‹é—´å¯ä»¥ç›¸äº’æ›¿æ¢ã€‚ç­–ç•¥æ¨¡å¼è®©ç®—æ³•çš„å˜åŒ–ç‹¬ç«‹äºä½¿ç”¨ç®—æ³•çš„å®¢æˆ·ã€‚

### åº”ç”¨åœºæ™¯
**ä»·æ ¼è®¡ç®—ç­–ç•¥** - æ ¹æ®å®¢æˆ·VIPç­‰çº§é‡‡ç”¨ä¸åŒçš„ä»·æ ¼è®¡ç®—æ–¹å¼

### å®ç°æ–¹å¼

#### ç­–ç•¥æ¥å£å®šä¹‰
```java
/**
 * ä»·æ ¼è®¡ç®—ç­–ç•¥æ¥å£
 */
public interface PriceCalculationStrategy {
    /**
     * è®¡ç®—ä»·æ ¼
     * @param roomType æˆ¿é—´ç±»å‹
     * @param days å…¥ä½å¤©æ•°
     * @param vipLevel VIPç­‰çº§
     * @return è®¡ç®—åçš„ä»·æ ¼
     */
    BigDecimal calculatePrice(RoomType roomType, int days, int vipLevel);
}
```

#### å…·ä½“ç­–ç•¥å®ç°

##### æ™®é€šå®¢æˆ·ä»·æ ¼ç­–ç•¥
```java
public class RegularPriceStrategy implements PriceCalculationStrategy {
    
    @Override
    public BigDecimal calculatePrice(RoomType roomType, int days, int vipLevel) {
        BigDecimal basePrice = roomType.getBasePrice();
        BigDecimal totalPrice = basePrice.multiply(new BigDecimal(days));
        
        logger.info("æ™®é€šå®¢æˆ·ä»·æ ¼è®¡ç®—: åŸºç¡€ä»·æ ¼={}, å¤©æ•°={}, æ€»ä»·={}", 
                   basePrice, days, totalPrice);
        
        return totalPrice;
    }
}
```

##### VIPå®¢æˆ·ä»·æ ¼ç­–ç•¥
```java
public class VIPPriceStrategy implements PriceCalculationStrategy {
    
    @Override
    public BigDecimal calculatePrice(RoomType roomType, int days, int vipLevel) {
        BigDecimal basePrice = roomType.getBasePrice();
        BigDecimal totalPrice = basePrice.multiply(new BigDecimal(days));
        
        // æ ¹æ®VIPç­‰çº§åº”ç”¨æŠ˜æ‰£
        BigDecimal discount = getVipDiscount(vipLevel);
        BigDecimal finalPrice = totalPrice.multiply(discount);
        
        logger.info("VIPå®¢æˆ·ä»·æ ¼è®¡ç®—: åŸºç¡€ä»·æ ¼={}, å¤©æ•°={}, VIPç­‰çº§={}, æŠ˜æ‰£={}, æœ€ç»ˆä»·æ ¼={}", 
                   basePrice, days, vipLevel, discount, finalPrice);
        
        return finalPrice;
    }
    
    private BigDecimal getVipDiscount(int vipLevel) {
        switch (vipLevel) {
            case 1: return new BigDecimal("0.95"); // 5%æŠ˜æ‰£
            case 2: return new BigDecimal("0.90"); // 10%æŠ˜æ‰£
            case 3: return new BigDecimal("0.85"); // 15%æŠ˜æ‰£
            case 4: return new BigDecimal("0.80"); // 20%æŠ˜æ‰£
            case 5: return new BigDecimal("0.75"); // 25%æŠ˜æ‰£
            default: return BigDecimal.ONE;        // æ— æŠ˜æ‰£
        }
    }
}
```

#### ç­–ç•¥ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰
```java
public class PriceCalculator {
    private PriceCalculationStrategy strategy;
    
    public void setStrategy(PriceCalculationStrategy strategy) {
        this.strategy = strategy;
    }
    
    public BigDecimal calculatePrice(RoomType roomType, int days, int vipLevel) {
        if (strategy == null) {
            throw new IllegalStateException("ä»·æ ¼è®¡ç®—ç­–ç•¥æœªè®¾ç½®");
        }
        return strategy.calculatePrice(roomType, days, vipLevel);
    }
}
```

#### åœ¨Serviceå±‚ä¸­çš„ä½¿ç”¨
```java
public class BookingService {
    
    public BigDecimal calculateTotalPrice(Booking booking) {
        Customer customer = booking.getCustomer();
        RoomType roomType = booking.getRoom().getRoomType();
        int days = (int) ChronoUnit.DAYS.between(
            booking.getCheckInDate().toInstant(), 
            booking.getCheckOutDate().toInstant()
        );
        
        // åˆ›å»ºä»·æ ¼è®¡ç®—å™¨
        PriceCalculator calculator = new PriceCalculator();
        
        // 4. é€‰æ‹©ç­–ç•¥
        PriceCalculationStrategy strategy;
        if (customer.getVipLevel() > 0) {
            strategy = new VIPPriceStrategy();
        } else {
            strategy = new RegularPriceStrategy();
        }
        
        calculator.setStrategy(strategy);
        return calculator.calculatePrice(roomType, days, customer.getVipLevel());
    }
}
```

### ç­–ç•¥æ¨¡å¼çš„ä¼˜åŠ¿
1. **ç®—æ³•ç‹¬ç«‹**ï¼šç®—æ³•å¯ä»¥ç‹¬ç«‹äºå®¢æˆ·å˜åŒ–
2. **è¿è¡Œæ—¶åˆ‡æ¢**ï¼šå¯ä»¥åœ¨è¿è¡Œæ—¶é€‰æ‹©ç®—æ³•
3. **å¼€é—­åŸåˆ™**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
4. **æ¶ˆé™¤æ¡ä»¶è¯­å¥**ï¼šé¿å…å¤§é‡if-elseæˆ–switchè¯­å¥

### ç­–ç•¥æ¨¡å¼æµç¨‹å›¾
```mermaid
flowchart TD
    A[åˆ›å»ºé¢„è®¢] --> B[è·å–å®¢æˆ·ä¿¡æ¯]
    B --> C[è·å–æˆ¿é—´ç±»å‹]
    C --> D{å®¢æˆ·VIPç­‰çº§}
    D -->|VIPå®¢æˆ·| E[é€‰æ‹©VIPä»·æ ¼ç­–ç•¥]
    D -->|æ™®é€šå®¢æˆ·| F[é€‰æ‹©æ™®é€šä»·æ ¼ç­–ç•¥]
    E --> G[è®¡ç®—VIPæŠ˜æ‰£ä»·æ ¼]
    F --> H[è®¡ç®—åŸä»·]
    G --> I[è¿”å›æœ€ç»ˆä»·æ ¼]
    H --> I
```

---

## ğŸ“ æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern)

### è®¾è®¡ç›®çš„
å®šä¹‰ä¸€ä¸ªç®—æ³•çš„éª¨æ¶ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ã€‚æ¨¡æ¿æ–¹æ³•ä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ç®—æ³•çš„ç»“æ„å³å¯é‡å®šä¹‰ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚

### åº”ç”¨åœºæ™¯
**é€šç”¨ä¸šåŠ¡æµç¨‹å¤„ç†** - æ ‡å‡†åŒ–çš„CRUDæ“ä½œæµç¨‹

### å®ç°æ–¹å¼

#### æŠ½è±¡æ¨¡æ¿ç±»
```java
public abstract class BaseService<T> {
    protected static final Logger logger = LogManager.getLogger();
    
    /**
     * æ¨¡æ¿æ–¹æ³•ï¼šæ ‡å‡†çš„ä¿å­˜æµç¨‹
     * @param entity è¦ä¿å­˜çš„å®ä½“
     * @return ä¿å­˜æ˜¯å¦æˆåŠŸ
     */
    public final boolean save(T entity) {
        try {
            // 1. ä¿å­˜å‰éªŒè¯
            if (!validateBeforeSave(entity)) {
                logger.warn("ä¿å­˜å‰éªŒè¯å¤±è´¥");
                return false;
            }
            
            // 2. ä¿å­˜å‰é¢„å¤„ç†
            preprocessBeforeSave(entity);
            
            // 3. æ‰§è¡Œä¿å­˜æ“ä½œï¼ˆå…·ä½“å®ç°ç”±å­ç±»å®Œæˆï¼‰
            boolean result = doSave(entity);
            
            if (result) {
                // 4. ä¿å­˜åå¤„ç†
                postprocessAfterSave(entity);
                logger.info("å®ä½“ä¿å­˜æˆåŠŸ: {}", entity.getClass().getSimpleName());
            } else {
                logger.error("å®ä½“ä¿å­˜å¤±è´¥: {}", entity.getClass().getSimpleName());
            }
            
            return result;
            
        } catch (Exception e) {
            logger.error("ä¿å­˜å®ä½“æ—¶å‘ç”Ÿå¼‚å¸¸", e);
            handleSaveException(entity, e);
            return false;
        }
    }
    
    /**
     * æ¨¡æ¿æ–¹æ³•ï¼šæ ‡å‡†çš„åˆ é™¤æµç¨‹
     * @param id è¦åˆ é™¤çš„å®ä½“ID
     * @return åˆ é™¤æ˜¯å¦æˆåŠŸ
     */
    public final boolean delete(Long id) {
        try {
            // 1. åˆ é™¤å‰éªŒè¯
            if (!validateBeforeDelete(id)) {
                logger.warn("åˆ é™¤å‰éªŒè¯å¤±è´¥ï¼ŒID: {}", id);
                return false;
            }
            
            // 2. è·å–è¦åˆ é™¤çš„å®ä½“
            T entity = findById(id);
            if (entity == null) {
                logger.warn("è¦åˆ é™¤çš„å®ä½“ä¸å­˜åœ¨ï¼ŒID: {}", id);
                return false;
            }
            
            // 3. åˆ é™¤å‰é¢„å¤„ç†
            preprocessBeforeDelete(entity);
            
            // 4. æ‰§è¡Œåˆ é™¤æ“ä½œ
            boolean result = doDelete(id);
            
            if (result) {
                // 5. åˆ é™¤åå¤„ç†
                postprocessAfterDelete(entity);
                logger.info("å®ä½“åˆ é™¤æˆåŠŸï¼ŒID: {}", id);
            } else {
                logger.error("å®ä½“åˆ é™¤å¤±è´¥ï¼ŒID: {}", id);
            }
            
            return result;
            
        } catch (Exception e) {
            logger.error("åˆ é™¤å®ä½“æ—¶å‘ç”Ÿå¼‚å¸¸ï¼ŒID: " + id, e);
            handleDeleteException(id, e);
            return false;
        }
    }
    
    // æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç°
    protected abstract boolean doSave(T entity);
    protected abstract boolean doDelete(Long id);
    protected abstract T findById(Long id);
    
    // é’©å­æ–¹æ³•ï¼Œå­ç±»å¯ä»¥è¦†ç›–
    protected boolean validateBeforeSave(T entity) {
        return entity != null;
    }
    
    protected boolean validateBeforeDelete(Long id) {
        return id != null && id > 0;
    }
    
    protected void preprocessBeforeSave(T entity) {
        // é»˜è®¤å®ç°ä¸ºç©ºï¼Œå­ç±»å¯ä»¥è¦†ç›–
    }
    
    protected void postprocessAfterSave(T entity) {
        // é»˜è®¤å®ç°ä¸ºç©ºï¼Œå­ç±»å¯ä»¥è¦†ç›–
    }
    
    protected void preprocessBeforeDelete(T entity) {
        // é»˜è®¤å®ç°ä¸ºç©ºï¼Œå­ç±»å¯ä»¥è¦†ç›–
    }
    
    protected void postprocessAfterDelete(T entity) {
        // é»˜è®¤å®ç°ä¸ºç©ºï¼Œå­ç±»å¯ä»¥è¦†ç›–
    }
    
    protected void handleSaveException(T entity, Exception e) {
        // é»˜è®¤å®ç°ï¼šè®°å½•é”™è¯¯æ—¥å¿—
        logger.error("ä¿å­˜å®ä½“å¼‚å¸¸å¤„ç†: {}", entity.getClass().getSimpleName(), e);
    }
    
    protected void handleDeleteException(Long id, Exception e) {
        // é»˜è®¤å®ç°ï¼šè®°å½•é”™è¯¯æ—¥å¿—
        logger.error("åˆ é™¤å®ä½“å¼‚å¸¸å¤„ç†ï¼ŒID: {}", id, e);
    }
}
```

#### å…·ä½“å®ç°ç±»
```java
public class BookingService extends BaseService<Booking> {
    private BookingDAO bookingDAO;
    private CustomerService customerService;
    private RoomService roomService;
    
    public BookingService() {
        this.bookingDAO = DAOFactory.getBookingDAO();
        this.customerService = new CustomerService();
        this.roomService = new RoomService();
    }
    
    @Override
    protected boolean doSave(Booking booking) {
        return bookingDAO.save(booking);
    }
    
    @Override
    protected boolean doDelete(Long id) {
        return bookingDAO.deleteById(id);
    }
    
    @Override
    protected Booking findById(Long id) {
        return bookingDAO.findById(id);
    }
    
    // è¦†ç›–é’©å­æ–¹æ³•ï¼Œæ·»åŠ ç‰¹å®šçš„éªŒè¯é€»è¾‘
    @Override
    protected boolean validateBeforeSave(Booking booking) {
        if (!super.validateBeforeSave(booking)) {
            return false;
        }
        
        // é¢„è®¢ç‰¹å®šçš„éªŒè¯
        if (booking.getCustomerId() == null) {
            logger.warn("å®¢æˆ·IDä¸èƒ½ä¸ºç©º");
            return false;
        }
        
        if (booking.getRoomId() == null) {
            logger.warn("æˆ¿é—´IDä¸èƒ½ä¸ºç©º");
            return false;
        }
        
        if (booking.getCheckInDate() == null || booking.getCheckOutDate() == null) {
            logger.warn("å…¥ä½å’Œé€€æˆ¿æ—¥æœŸä¸èƒ½ä¸ºç©º");
            return false;
        }
        
        if (booking.getCheckInDate().after(booking.getCheckOutDate())) {
            logger.warn("å…¥ä½æ—¥æœŸä¸èƒ½æ™šäºé€€æˆ¿æ—¥æœŸ");
            return false;
        }
        
        return true;
    }
    
    @Override
    protected void preprocessBeforeSave(Booking booking) {
        // è®¾ç½®åˆ›å»ºæ—¶é—´
        if (booking.getCreateTime() == null) {
            booking.setCreateTime(new Date());
        }
        
        // è®¡ç®—æ€»ä»·æ ¼
        BigDecimal totalPrice = calculateTotalPrice(booking);
        booking.setTotalPrice(totalPrice);
        
        // å¦‚æœæ˜¯æ–°é¢„è®¢ï¼Œè®¾ç½®çŠ¶æ€ä¸ºå¾…ç¡®è®¤
        if (booking.getBookingId() == null) {
            booking.setStatus(BookingStatus.PENDING);
        }
    }
    
    @Override
    protected void postprocessAfterSave(Booking booking) {
        // å‘é€ç¡®è®¤é‚®ä»¶ï¼ˆå¦‚æœæœ‰é‚®ä»¶æœåŠ¡ï¼‰
        sendConfirmationEmail(booking);
        
        // æ›´æ–°æˆ¿é—´çŠ¶æ€
        if (booking.getStatus() == BookingStatus.CONFIRMED) {
            roomService.updateRoomStatus(booking.getRoomId(), RoomStatus.OCCUPIED);
        }
    }
    
    @Override
    protected boolean validateBeforeDelete(Long id) {
        if (!super.validateBeforeDelete(id)) {
            return false;
        }
        
        // æ£€æŸ¥é¢„è®¢æ˜¯å¦å¯ä»¥åˆ é™¤
        Booking booking = findById(id);
        if (booking != null && booking.getStatus() == BookingStatus.CHECKED_IN) {
            logger.warn("å·²å…¥ä½çš„é¢„è®¢ä¸èƒ½åˆ é™¤ï¼ŒID: {}", id);
            return false;
        }
        
        return true;
    }
    
    @Override
    protected void postprocessAfterDelete(Booking booking) {
        // å¦‚æœé¢„è®¢è¢«åˆ é™¤ï¼Œé‡Šæ”¾æˆ¿é—´
        if (booking.getStatus() == BookingStatus.CONFIRMED) {
            roomService.updateRoomStatus(booking.getRoomId(), RoomStatus.AVAILABLE);
        }
    }
    
    // ç§æœ‰è¾…åŠ©æ–¹æ³•
    private BigDecimal calculateTotalPrice(Booking booking) {
        // ä»·æ ¼è®¡ç®—é€»è¾‘ï¼ˆä½¿ç”¨ç­–ç•¥æ¨¡å¼ï¼‰
        return new PriceCalculator().calculatePrice(
            booking.getRoom().getRoomType(),
            getDaysBetween(booking.getCheckInDate(), booking.getCheckOutDate()),
            booking.getCustomer().getVipLevel()
        );
    }
    
    private void sendConfirmationEmail(Booking booking) {
        // å‘é€ç¡®è®¤é‚®ä»¶çš„é€»è¾‘
        logger.info("å‘é€é¢„è®¢ç¡®è®¤é‚®ä»¶ç»™å®¢æˆ·: {}", booking.getCustomer().getName());
    }
    
    private int getDaysBetween(Date checkIn, Date checkOut) {
        return (int) ((checkOut.getTime() - checkIn.getTime()) / (1000 * 60 * 60 * 24));
    }
}
```

### æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ä¼˜åŠ¿
1. **ä»£ç å¤ç”¨**ï¼šå…¬å…±ç®—æ³•æ”¾åœ¨çˆ¶ç±»ä¸­
2. **æ§åˆ¶æ‰©å±•**ï¼šé’©å­æ–¹æ³•æ§åˆ¶ç®—æ³•çš„æ‰©å±•ç‚¹
3. **ç¬¦åˆå¼€é—­åŸåˆ™**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
4. **ç»Ÿä¸€æµç¨‹**ï¼šç¡®ä¿å­ç±»éµå¾ªç›¸åŒçš„ç®—æ³•éª¨æ¶

### æ¨¡æ¿æ–¹æ³•æµç¨‹å›¾
```mermaid
flowchart TD
    A[å¼€å§‹ä¿å­˜æ“ä½œ] --> B[ä¿å­˜å‰éªŒè¯]
    B --> C{éªŒè¯é€šè¿‡?}
    C -->|å¦| D[è¿”å›å¤±è´¥]
    C -->|æ˜¯| E[ä¿å­˜å‰é¢„å¤„ç†]
    E --> F[æ‰§è¡Œä¿å­˜æ“ä½œ]
    F --> G{ä¿å­˜æˆåŠŸ?}
    G -->|å¦| H[è®°å½•é”™è¯¯æ—¥å¿—]
    G -->|æ˜¯| I[ä¿å­˜åå¤„ç†]
    I --> J[è¿”å›æˆåŠŸ]
    H --> D
    
    style A fill:#e1f5fe
    style J fill:#c8e6c9
    style D fill:#ffcdd2
```

---

## ğŸ’¾ DAOæ¨¡å¼ (Data Access Object Pattern)

### è®¾è®¡ç›®çš„
å°†æ•°æ®è®¿é—®é€»è¾‘å°è£…åœ¨å•ç‹¬çš„å±‚ä¸­ï¼Œä¸ºä¸šåŠ¡é€»è¾‘å±‚æä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£ã€‚

### åº”ç”¨åœºæ™¯
**æ•°æ®è®¿é—®å±‚çš„ç»Ÿä¸€æŠ½è±¡** - ä¸ºæ‰€æœ‰å®ä½“æä¾›æ ‡å‡†çš„CRUDæ“ä½œ

### å®ç°æ–¹å¼

#### é€šç”¨DAOæ¥å£
```java
/**
 * é€šç”¨DAOæ¥å£ï¼Œå®šä¹‰åŸºæœ¬çš„CRUDæ“ä½œ
 * @param <T> å®ä½“ç±»å‹
 */
public interface BaseDAO<T> {
    
    /**
     * ä¿å­˜å®ä½“
     * @param entity è¦ä¿å­˜çš„å®ä½“
     * @return ä¿å­˜æ˜¯å¦æˆåŠŸ
     */
    boolean save(T entity);
    
    /**
     * æ ¹æ®IDæŸ¥æ‰¾å®ä½“
     * @param id å®ä½“ID
     * @return å®ä½“å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å›null
     */
    T findById(Long id);
    
    /**
     * æŸ¥æ‰¾æ‰€æœ‰å®ä½“
     * @return å®ä½“åˆ—è¡¨
     */
    List<T> findAll();
    
    /**
     * æ›´æ–°å®ä½“
     * @param entity è¦æ›´æ–°çš„å®ä½“
     * @return æ›´æ–°æ˜¯å¦æˆåŠŸ
     */
    boolean update(T entity);
    
    /**
     * æ ¹æ®IDåˆ é™¤å®ä½“
     * @param id è¦åˆ é™¤çš„å®ä½“ID
     * @return åˆ é™¤æ˜¯å¦æˆåŠŸ
     */
    boolean deleteById(Long id);
    
    /**
     * è·å–å®ä½“æ€»æ•°
     * @return å®ä½“æ€»æ•°
     */
    long count();
    
    /**
     * åˆ†é¡µæŸ¥è¯¢
     * @param offset åç§»é‡
     * @param limit é™åˆ¶æ•°é‡
     * @return å®ä½“åˆ—è¡¨
     */
    List<T> findByPage(int offset, int limit);
}
```

#### å…·ä½“DAOæ¥å£
```java
/**
 * é¢„è®¢DAOæ¥å£
 */
public interface BookingDAO extends BaseDAO<Booking> {
    
    /**
     * æ ¹æ®å®¢æˆ·IDæŸ¥æ‰¾é¢„è®¢
     * @param customerId å®¢æˆ·ID
     * @return é¢„è®¢åˆ—è¡¨
     */
    List<Booking> findByCustomerId(Long customerId);
    
    /**
     * æ ¹æ®æˆ¿é—´IDæŸ¥æ‰¾é¢„è®¢
     * @param roomId æˆ¿é—´ID
     * @return é¢„è®¢åˆ—è¡¨
     */
    List<Booking> findByRoomId(Long roomId);
    
    /**
     * æ ¹æ®çŠ¶æ€æŸ¥æ‰¾é¢„è®¢
     * @param status é¢„è®¢çŠ¶æ€
     * @return é¢„è®¢åˆ—è¡¨
     */
    List<Booking> findByStatus(BookingStatus status);
    
    /**
     * æŸ¥æ‰¾æŒ‡å®šæ—¥æœŸèŒƒå›´å†…çš„é¢„è®¢
     * @param startDate å¼€å§‹æ—¥æœŸ
     * @param endDate ç»“æŸæ—¥æœŸ
     * @return é¢„è®¢åˆ—è¡¨
     */
    List<Booking> findByDateRange(Date startDate, Date endDate);
    
    /**
     * æŸ¥æ‰¾ä»Šæ—¥å…¥ä½çš„é¢„è®¢
     * @return é¢„è®¢åˆ—è¡¨
     */
    List<Booking> findTodayCheckIns();
    
    /**
     * æŸ¥æ‰¾ä»Šæ—¥é€€æˆ¿çš„é¢„è®¢
     * @return é¢„è®¢åˆ—è¡¨
     */
    List<Booking> findTodayCheckOuts();
    
    /**
     * æ£€æŸ¥æˆ¿é—´åœ¨æŒ‡å®šæ—¶é—´æ®µæ˜¯å¦å¯ç”¨
     * @param roomId æˆ¿é—´ID
     * @param checkInDate å…¥ä½æ—¥æœŸ
     * @param checkOutDate é€€æˆ¿æ—¥æœŸ
     * @return æ˜¯å¦å¯ç”¨
     */
    boolean isRoomAvailable(Long roomId, Date checkInDate, Date checkOutDate);
}
```

#### DAOå®ç°ç±»
```java
public class BookingDAOImpl implements BookingDAO {
    private static final Logger logger = LogManager.getLogger(BookingDAOImpl.class);
    private ConnectionPool connectionPool;
    
    public BookingDAOImpl() {
        this.connectionPool = ConnectionPool.getInstance();
    }
    
    @Override
    public boolean save(Booking booking) {
        String sql = """
            INSERT INTO bookings (customer_id, room_id, check_in_date, check_out_date, 
                                total_price, status, special_requests, create_time, update_time)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        """;
        
        try (Connection conn = connectionPool.getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS)) {
            
            stmt.setLong(1, booking.getCustomerId());
            stmt.setLong(2, booking.getRoomId());
            stmt.setTimestamp(3, new Timestamp(booking.getCheckInDate().getTime()));
            stmt.setTimestamp(4, new Timestamp(booking.getCheckOutDate().getTime()));
            stmt.setBigDecimal(5, booking.getTotalPrice());
            stmt.setString(6, booking.getStatus().name());
            stmt.setString(7, booking.getSpecialRequests());
            stmt.setTimestamp(8, new Timestamp(booking.getCreateTime().getTime()));
            stmt.setTimestamp(9, new Timestamp(booking.getUpdateTime().getTime()));
            
            int result = stmt.executeUpdate();
            
            if (result > 0) {
                // è·å–ç”Ÿæˆçš„ID
                try (ResultSet generatedKeys = stmt.getGeneratedKeys()) {
                    if (generatedKeys.next()) {
                        booking.setBookingId(generatedKeys.getLong(1));
                    }
                }
                logger.info("é¢„è®¢ä¿å­˜æˆåŠŸï¼ŒID: {}", booking.getBookingId());
                return true;
            }
            
        } catch (SQLException e) {
            logger.error("ä¿å­˜é¢„è®¢å¤±è´¥", e);
        }
        
        return false;
    }
    
    @Override
    public Booking findById(Long id) {
        String sql = """
            SELECT b.*, c.name as customer_name, c.phone as customer_phone,
                   r.room_number, rt.type_name, rt.base_price
            FROM bookings b
            JOIN customers c ON b.customer_id = c.customer_id
            JOIN rooms r ON b.room_id = r.room_id
            JOIN room_types rt ON r.room_type_id = rt.room_type_id
            WHERE b.booking_id = ?
        """;
        
        try (Connection conn = connectionPool.getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {
            
            stmt.setLong(1, id);
            
            try (ResultSet rs = stmt.executeQuery()) {
                if (rs.next()) {
                    return mapResultSetToBooking(rs);
                }
            }
            
        } catch (SQLException e) {
            logger.error("æ ¹æ®IDæŸ¥æ‰¾é¢„è®¢å¤±è´¥ï¼ŒID: " + id, e);
        }
        
        return null;
    }
    
    @Override
    public List<Booking> findByStatus(BookingStatus status) {
        String sql = """
            SELECT b.*, c.name as customer_name, c.phone as customer_phone,
                   r.room_number, rt.type_name, rt.base_price
            FROM bookings b
            JOIN customers c ON b.customer_id = c.customer_id
            JOIN rooms r ON b.room_id = r.room_id
            JOIN room_types rt ON r.room_type_id = rt.room_type_id
            WHERE b.status = ?
            ORDER BY b.check_in_date DESC
        """;
        
        List<Booking> bookings = new ArrayList<>();
        
        try (Connection conn = connectionPool.getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {
            
            stmt.setString(1, status.name());
            
            try (ResultSet rs = stmt.executeQuery()) {
                while (rs.next()) {
                    bookings.add(mapResultSetToBooking(rs));
                }
            }
            
        } catch (SQLException e) {
            logger.error("æ ¹æ®çŠ¶æ€æŸ¥æ‰¾é¢„è®¢å¤±è´¥ï¼ŒçŠ¶æ€: " + status, e);
        }
        
        return bookings;
    }
    
    @Override
    public boolean isRoomAvailable(Long roomId, Date checkInDate, Date checkOutDate) {
        String sql = """
            SELECT COUNT(*) FROM bookings 
            WHERE room_id = ? 
            AND status IN ('CONFIRMED', 'CHECKED_IN')
            AND (
                (check_in_date <= ? AND check_out_date > ?) OR
                (check_in_date < ? AND check_out_date >= ?) OR
                (check_in_date >= ? AND check_out_date <= ?)
            )
        """;
        
        try (Connection conn = connectionPool.getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {
            
            Timestamp checkIn = new Timestamp(checkInDate.getTime());
            Timestamp checkOut = new Timestamp(checkOutDate.getTime());
            
            stmt.setLong(1, roomId);
            stmt.setTimestamp(2, checkIn);
            stmt.setTimestamp(3, checkIn);
            stmt.setTimestamp(4, checkOut);
            stmt.setTimestamp(5, checkOut);
            stmt.setTimestamp(6, checkIn);
            stmt.setTimestamp(7, checkOut);
            
            try (ResultSet rs = stmt.executeQuery()) {
                if (rs.next()) {
                    return rs.getInt(1) == 0; // æ²¡æœ‰å†²çªçš„é¢„è®¢åˆ™å¯ç”¨
                }
            }
            
        } catch (SQLException e) {
            logger.error("æ£€æŸ¥æˆ¿é—´å¯ç”¨æ€§å¤±è´¥", e);
        }
        
        return false;
    }
    
    /**
     * å°†ResultSetæ˜ å°„ä¸ºBookingå¯¹è±¡
     */
    private Booking mapResultSetToBooking(ResultSet rs) throws SQLException {
        Booking booking = new Booking();
        
        booking.setBookingId(rs.getLong("booking_id"));
        booking.setCustomerId(rs.getLong("customer_id"));
        booking.setRoomId(rs.getLong("room_id"));
        booking.setCheckInDate(rs.getTimestamp("check_in_date"));
        booking.setCheckOutDate(rs.getTimestamp("check_out_date"));
        booking.setTotalPrice(rs.getBigDecimal("total_price"));
        booking.setStatus(BookingStatus.valueOf(rs.getString("status")));
        booking.setSpecialRequests(rs.getString("special_requests"));
        booking.setCreateTime(rs.getTimestamp("create_time"));
        booking.setUpdateTime(rs.getTimestamp("update_time"));
        
        // è®¾ç½®å…³è”çš„å®¢æˆ·ä¿¡æ¯
        Customer customer = new Customer();
        customer.setCustomerId(rs.getLong("customer_id"));
        customer.setName(rs.getString("customer_name"));
        customer.setPhone(rs.getString("customer_phone"));
        booking.setCustomer(customer);
        
        // è®¾ç½®å…³è”çš„æˆ¿é—´ä¿¡æ¯
        Room room = new Room();
        room.setRoomId(rs.getLong("room_id"));
        room.setRoomNumber(rs.getString("room_number"));
        
        RoomType roomType = new RoomType();
        roomType.setTypeName(rs.getString("type_name"));
        roomType.setBasePrice(rs.getBigDecimal("base_price"));
        room.setRoomType(roomType);
        
        booking.setRoom(room);
        
        return booking;
    }
    
    // å®ç°å…¶ä»–æ¥å£æ–¹æ³•...
}
```

### DAOæ¨¡å¼çš„ä¼˜åŠ¿
1. **åˆ†ç¦»å…³æ³¨ç‚¹**ï¼šæ•°æ®è®¿é—®é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
2. **æ•°æ®åº“æ— å…³**ï¼šå¯ä»¥è½»æ¾åˆ‡æ¢ä¸åŒçš„æ•°æ®åº“
3. **ç»Ÿä¸€æ¥å£**ï¼šä¸ºæ‰€æœ‰å®ä½“æä¾›ä¸€è‡´çš„æ•°æ®è®¿é—®æ–¹å¼
4. **æ˜“äºæµ‹è¯•**ï¼šå¯ä»¥ä½¿ç”¨Mockå¯¹è±¡è¿›è¡Œå•å…ƒæµ‹è¯•

---

## ğŸ‘€ è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

### è®¾è®¡ç›®çš„
å®šä¹‰å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è¢«è‡ªåŠ¨æ›´æ–°ã€‚

### åº”ç”¨åœºæ™¯
**æ—¥å¿—è®°å½•å’Œäº‹ä»¶é€šçŸ¥** - ç³»ç»ŸçŠ¶æ€å˜åŒ–æ—¶çš„é€šçŸ¥æœºåˆ¶

### å®ç°æ–¹å¼

#### äº‹ä»¶å’Œè§‚å¯Ÿè€…æ¥å£
```java
/**
 * ç³»ç»Ÿäº‹ä»¶æ¥å£
 */
public interface SystemEvent {
    String getEventType();
    Object getSource();
    Date getTimestamp();
    Map<String, Object> getEventData();
}

/**
 * äº‹ä»¶è§‚å¯Ÿè€…æ¥å£
 */
public interface EventObserver {
    void onEvent(SystemEvent event);
    boolean canHandle(String eventType);
}
```

#### å…·ä½“äº‹ä»¶å®ç°
```java
/**
 * é¢„è®¢äº‹ä»¶
 */
public class BookingEvent implements SystemEvent {
    private String eventType;
    private Booking booking;
    private Date timestamp;
    private Map<String, Object> eventData;
    
    public BookingEvent(String eventType, Booking booking) {
        this.eventType = eventType;
        this.booking = booking;
        this.timestamp = new Date();
        this.eventData = new HashMap<>();
        
        // æ·»åŠ äº‹ä»¶æ•°æ®
        eventData.put("bookingId", booking.getBookingId());
        eventData.put("customerId", booking.getCustomerId());
        eventData.put("roomId", booking.getRoomId());
        eventData.put("status", booking.getStatus());
    }
    
    @Override
    public String getEventType() {
        return eventType;
    }
    
    @Override
    public Object getSource() {
        return booking;
    }
    
    @Override
    public Date getTimestamp() {
        return timestamp;
    }
    
    @Override
    public Map<String, Object> getEventData() {
        return eventData;
    }
    
    // äº‹ä»¶ç±»å‹å¸¸é‡
    public static final String BOOKING_CREATED = "BOOKING_CREATED";
    public static final String BOOKING_CONFIRMED = "BOOKING_CONFIRMED";
    public static final String BOOKING_CHECKED_IN = "BOOKING_CHECKED_IN";
    public static final String BOOKING_CHECKED_OUT = "BOOKING_CHECKED_OUT";
    public static final String BOOKING_CANCELLED = "BOOKING_CANCELLED";
}
```

#### å…·ä½“è§‚å¯Ÿè€…å®ç°
```java
/**
 * æ—¥å¿—è®°å½•è§‚å¯Ÿè€…
 */
public class LoggingObserver implements EventObserver {
    private static final Logger logger = LogManager.getLogger(LoggingObserver.class);
    
    @Override
    public void onEvent(SystemEvent event) {
        logger.info("ç³»ç»Ÿäº‹ä»¶ - ç±»å‹: {}, æ—¶é—´: {}, æ•°æ®: {}", 
                   event.getEventType(), 
                   event.getTimestamp(), 
                   event.getEventData());
    }
    
    @Override
    public boolean canHandle(String eventType) {
        return true; // æ—¥å¿—è§‚å¯Ÿè€…å¤„ç†æ‰€æœ‰äº‹ä»¶
    }
}

/**
 * é‚®ä»¶é€šçŸ¥è§‚å¯Ÿè€…
 */
public class EmailNotificationObserver implements EventObserver {
    private static final Logger logger = LogManager.getLogger(EmailNotificationObserver.class);
    
    @Override
    public void onEvent(SystemEvent event) {
        if (event instanceof BookingEvent) {
            BookingEvent bookingEvent = (BookingEvent) event;
            Booking booking = (Booking) bookingEvent.getSource();
            
            switch (bookingEvent.getEventType()) {
                case BookingEvent.BOOKING_CREATED:
                    sendBookingCreatedEmail(booking);
                    break;
                case BookingEvent.BOOKING_CONFIRMED:
                    sendBookingConfirmedEmail(booking);
                    break;
                case BookingEvent.BOOKING_CANCELLED:
                    sendBookingCancelledEmail(booking);
                    break;
            }
        }
    }
    
    @Override
    public boolean canHandle(String eventType) {
        return eventType.startsWith("BOOKING_");
    }
    
    private void sendBookingCreatedEmail(Booking booking) {
        // å‘é€é¢„è®¢åˆ›å»ºç¡®è®¤é‚®ä»¶
        logger.info("å‘é€é¢„è®¢åˆ›å»ºç¡®è®¤é‚®ä»¶ç»™å®¢æˆ·: {}", booking.getCustomer().getName());
    }
    
    private void sendBookingConfirmedEmail(Booking booking) {
        // å‘é€é¢„è®¢ç¡®è®¤é‚®ä»¶
        logger.info("å‘é€é¢„è®¢ç¡®è®¤é‚®ä»¶ç»™å®¢æˆ·: {}", booking.getCustomer().getName());
    }
    
    private void sendBookingCancelledEmail(Booking booking) {
        // å‘é€é¢„è®¢å–æ¶ˆé€šçŸ¥é‚®ä»¶
        logger.info("å‘é€é¢„è®¢å–æ¶ˆé€šçŸ¥é‚®ä»¶ç»™å®¢æˆ·: {}", booking.getCustomer().getName());
    }
}

/**
 * ç»Ÿè®¡æ•°æ®æ›´æ–°è§‚å¯Ÿè€…
 */
public class StatisticsObserver implements EventObserver {
    private static final Logger logger = LogManager.getLogger(StatisticsObserver.class);
    
    @Override
    public void onEvent(SystemEvent event) {
        if (event instanceof BookingEvent) {
            updateBookingStatistics((BookingEvent) event);
        }
    }
    
    @Override
    public boolean canHandle(String eventType) {
        return eventType.startsWith("BOOKING_");
    }
    
    private void updateBookingStatistics(BookingEvent event) {
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        logger.info("æ›´æ–°é¢„è®¢ç»Ÿè®¡æ•°æ®: {}", event.getEventType());
        
        switch (event.getEventType()) {
            case BookingEvent.BOOKING_CREATED:
                // å¢åŠ æ–°é¢„è®¢è®¡æ•°
                break;
            case BookingEvent.BOOKING_CONFIRMED:
                // å¢åŠ ç¡®è®¤é¢„è®¢è®¡æ•°
                break;
            case BookingEvent.BOOKING_CHECKED_IN:
                // å¢åŠ å…¥ä½è®¡æ•°
                break;
            case BookingEvent.BOOKING_CHECKED_OUT:
                // å¢åŠ é€€æˆ¿è®¡æ•°
                break;
            case BookingEvent.BOOKING_CANCELLED:
                // å¢åŠ å–æ¶ˆè®¡æ•°
                break;
        }
    }
}
```

#### äº‹ä»¶å‘å¸ƒå™¨ï¼ˆSubjectï¼‰
```java
/**
 * äº‹ä»¶å‘å¸ƒå™¨
 * ç®¡ç†è§‚å¯Ÿè€…åˆ—è¡¨å¹¶å‘å¸ƒäº‹ä»¶
 */
public class EventPublisher {
    private static final Logger logger = LogManager.getLogger(EventPublisher.class);
    private static volatile EventPublisher instance;
    
    private List<EventObserver> observers;
    
    private EventPublisher() {
        this.observers = new ArrayList<>();
        initializeObservers();
    }
    
    public static EventPublisher getInstance() {
        if (instance == null) {
            synchronized (EventPublisher.class) {
                if (instance == null) {
                    instance = new EventPublisher();
                }
            }
        }
        return instance;
    }
    
    /**
     * åˆå§‹åŒ–è§‚å¯Ÿè€…
     */
    private void initializeObservers() {
        addObserver(new LoggingObserver());
        addObserver(new EmailNotificationObserver());
        addObserver(new StatisticsObserver());
    }
    
    /**
     * æ·»åŠ è§‚å¯Ÿè€…
     */
    public void addObserver(EventObserver observer) {
        observers.add(observer);
        logger.info("æ·»åŠ äº‹ä»¶è§‚å¯Ÿè€…: {}", observer.getClass().getSimpleName());
    }
    
    /**
     * ç§»é™¤è§‚å¯Ÿè€…
     */
    public void removeObserver(EventObserver observer) {
        observers.remove(observer);
        logger.info("ç§»é™¤äº‹ä»¶è§‚å¯Ÿè€…: {}", observer.getClass().getSimpleName());
    }
    
    /**
     * å‘å¸ƒäº‹ä»¶
     */
    public void publishEvent(SystemEvent event) {
        logger.debug("å‘å¸ƒäº‹ä»¶: {}", event.getEventType());
        
        for (EventObserver observer : observers) {
            try {
                if (observer.canHandle(event.getEventType())) {
                    observer.onEvent(event);
                }
            } catch (Exception e) {
                logger.error("è§‚å¯Ÿè€…å¤„ç†äº‹ä»¶å¤±è´¥: " + observer.getClass().getSimpleName(), e);
            }
        }
    }
}
```

#### åœ¨Serviceå±‚ä¸­ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼
```java
public class BookingService extends BaseService<Booking> {
    private EventPublisher eventPublisher;
    
    public BookingService() {
        super();
        this.eventPublisher = EventPublisher.getInstance();
    }
    
    @Override
    protected void postprocessAfterSave(Booking booking) {
        // å‘å¸ƒé¢„è®¢åˆ›å»ºäº‹ä»¶
        BookingEvent event = new BookingEvent(BookingEvent.BOOKING_CREATED, booking);
        eventPublisher.publishEvent(event);
    }
    
    public boolean confirmBooking(Long bookingId) {
        Booking booking = findById(bookingId);
        if (booking != null && booking.getStatus() == BookingStatus.PENDING) {
            booking.setStatus(BookingStatus.CONFIRMED);
            booking.setUpdateTime(new Date());
            
            boolean result = update(booking);
            if (result) {
                // å‘å¸ƒé¢„è®¢ç¡®è®¤äº‹ä»¶
                BookingEvent event = new BookingEvent(BookingEvent.BOOKING_CONFIRMED, booking);
                eventPublisher.publishEvent(event);
            }
            return result;
        }
        return false;
    }
    
    public boolean checkIn(Long bookingId) {
        Booking booking = findById(bookingId);
        if (booking != null && booking.getStatus() == BookingStatus.CONFIRMED) {
            booking.setStatus(BookingStatus.CHECKED_IN);
            booking.setUpdateTime(new Date());
            
            boolean result = update(booking);
            if (result) {
                // å‘å¸ƒå…¥ä½äº‹ä»¶
                BookingEvent event = new BookingEvent(BookingEvent.BOOKING_CHECKED_IN, booking);
                eventPublisher.publishEvent(event);
            }
            return result;
        }
        return false;
    }
}
```

### è§‚å¯Ÿè€…æ¨¡å¼çš„ä¼˜åŠ¿
1. **æ¾è€¦åˆ**ï¼šè§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…ä¹‹é—´æ¾è€¦åˆ
2. **åŠ¨æ€å…³ç³»**ï¼šå¯ä»¥åœ¨è¿è¡Œæ—¶å»ºç«‹æˆ–åˆ é™¤è§‚å¯Ÿå…³ç³»
3. **å¼€é—­åŸåˆ™**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
4. **å¹¿æ’­é€šä¿¡**ï¼šä¸€ä¸ªäº‹ä»¶å¯ä»¥é€šçŸ¥å¤šä¸ªè§‚å¯Ÿè€…

---

## ğŸ”— è®¾è®¡æ¨¡å¼åä½œ

### æ¨¡å¼é—´çš„åä½œå…³ç³»

```mermaid
graph TB
    subgraph "åˆ›å»ºå‹æ¨¡å¼"
        S[å•ä¾‹æ¨¡å¼]
        F[å·¥å‚æ¨¡å¼]
    end
    
    subgraph "ç»“æ„å‹æ¨¡å¼"
        D[DAOæ¨¡å¼]
    end
    
    subgraph "è¡Œä¸ºå‹æ¨¡å¼"
        ST[ç­–ç•¥æ¨¡å¼]
        TM[æ¨¡æ¿æ–¹æ³•æ¨¡å¼]
        O[è§‚å¯Ÿè€…æ¨¡å¼]
    end
    
    subgraph "ä¸šåŠ¡æµç¨‹"
        Config[é…ç½®ç®¡ç†]
        Create[å¯¹è±¡åˆ›å»º]
        Business[ä¸šåŠ¡å¤„ç†]
        Data[æ•°æ®è®¿é—®]
        Event[äº‹ä»¶é€šçŸ¥]
    end
    
    S --> Config
    F --> Create
    D --> Data
    ST --> Business
    TM --> Business
    O --> Event
    
    Config --> Create
    Create --> Business
    Business --> Data
    Business --> Event
```

### è®¾è®¡æ¨¡å¼çš„ç»¼åˆåº”ç”¨å®ä¾‹

ä»¥é¢„è®¢åˆ›å»ºæµç¨‹ä¸ºä¾‹ï¼Œå±•ç¤ºå¤šä¸ªè®¾è®¡æ¨¡å¼çš„åä½œï¼š

```java
public class BookingCreationExample {
    
    public void createBookingExample() {
        // 1. å•ä¾‹æ¨¡å¼ - è·å–é…ç½®ç®¡ç†å™¨
        ConfigManager config = ConfigManager.getInstance();
        
        // 2. å•ä¾‹æ¨¡å¼ - è·å–è¿æ¥æ± 
        ConnectionPool pool = ConnectionPool.getInstance();
        
        // 3. å·¥å‚æ¨¡å¼ - åˆ›å»ºDAOå®ä¾‹
        BookingDAO bookingDAO = DAOFactory.getBookingDAO();
        CustomerDAO customerDAO = DAOFactory.getCustomerDAO();
        
        // 4. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ - ä½¿ç”¨æ ‡å‡†ä¸šåŠ¡æµç¨‹
        BookingService bookingService = new BookingService();
        
        // 5. åˆ›å»ºé¢„è®¢å¯¹è±¡
        Booking booking = new Booking();
        booking.setCustomerId(1L);
        booking.setRoomId(101L);
        booking.setCheckInDate(new Date());
        booking.setCheckOutDate(new Date(System.currentTimeMillis() + 86400000)); // æ˜å¤©
        
        // 6. ç­–ç•¥æ¨¡å¼ - è®¡ç®—ä»·æ ¼
        Customer customer = customerDAO.findById(1L);
        PriceCalculationStrategy strategy;
        if (customer.getVipLevel() > 0) {
            strategy = new VIPPriceStrategy();
        } else {
            strategy = new RegularPriceStrategy();
        }
        
        PriceCalculator calculator = new PriceCalculator();
        calculator.setStrategy(strategy);
        
        // 7. ä½¿ç”¨æ¨¡æ¿æ–¹æ³•ä¿å­˜é¢„è®¢ï¼ˆä¼šè§¦å‘è§‚å¯Ÿè€…æ¨¡å¼ï¼‰
        boolean result = bookingService.save(booking);
        
        // 8. è§‚å¯Ÿè€…æ¨¡å¼ä¼šè‡ªåŠ¨è§¦å‘ï¼š
        // - æ—¥å¿—è®°å½•
        // - é‚®ä»¶é€šçŸ¥
        // - ç»Ÿè®¡æ•°æ®æ›´æ–°
        
        if (result) {
            System.out.println("é¢„è®¢åˆ›å»ºæˆåŠŸï¼ŒID: " + booking.getBookingId());
        }
    }
}
```

### è®¾è®¡æ¨¡å¼çš„ä»·å€¼æ€»ç»“

1. **æé«˜ä»£ç è´¨é‡**ï¼š
   - é™ä½è€¦åˆåº¦
   - æé«˜å†…èšæ€§
   - å¢å¼ºå¯è¯»æ€§

2. **å¢å¼ºç³»ç»Ÿæ‰©å±•æ€§**ï¼š
   - ç¬¦åˆå¼€é—­åŸåˆ™
   - æ”¯æŒåŠŸèƒ½æ‰©å±•
   - ä¾¿äºéœ€æ±‚å˜æ›´

3. **ç®€åŒ–ç³»ç»Ÿç»´æŠ¤**ï¼š
   - ä»£ç ç»“æ„æ¸…æ™°
   - èŒè´£åˆ†ç¦»æ˜ç¡®
   - ä¾¿äºå®šä½é—®é¢˜

4. **ä¿ƒè¿›ä»£ç å¤ç”¨**ï¼š
   - é€šç”¨ç»„ä»¶æŠ½è±¡
   - å‡å°‘é‡å¤ä»£ç 
   - æé«˜å¼€å‘æ•ˆç‡

---

## ğŸ”š æ€»ç»“

æœ¬é…’åº—ç®¡ç†ç³»ç»Ÿé€šè¿‡åˆç†è¿ç”¨6ç§è®¾è®¡æ¨¡å¼ï¼Œæ„å»ºäº†ä¸€ä¸ªç»“æ„æ¸…æ™°ã€åŠŸèƒ½å®Œå–„ã€æ˜“äºç»´æŠ¤å’Œæ‰©å±•çš„ç³»ç»Ÿæ¶æ„ï¼š

- **å•ä¾‹æ¨¡å¼**ç¡®ä¿äº†é…ç½®ç®¡ç†å’Œè¿æ¥æ± çš„å…¨å±€å”¯ä¸€æ€§
- **å·¥å‚æ¨¡å¼**å®ç°äº†DAOå¯¹è±¡åˆ›å»ºçš„è§£è€¦
- **ç­–ç•¥æ¨¡å¼**æä¾›äº†çµæ´»çš„ä»·æ ¼è®¡ç®—æœºåˆ¶
- **æ¨¡æ¿æ–¹æ³•æ¨¡å¼**æ ‡å‡†åŒ–äº†ä¸šåŠ¡æµç¨‹å¤„ç†
- **DAOæ¨¡å¼**å°è£…äº†æ•°æ®è®¿é—®é€»è¾‘
- **è§‚å¯Ÿè€…æ¨¡å¼**å®ç°äº†äº‹ä»¶é©±åŠ¨çš„é€šçŸ¥æœºåˆ¶

è¿™äº›è®¾è®¡æ¨¡å¼ä¸æ˜¯å­¤ç«‹å­˜åœ¨çš„ï¼Œè€Œæ˜¯ç›¸äº’é…åˆï¼Œå…±åŒæ„æˆäº†ä¸€ä¸ªå¼ºå¤§çš„è½¯ä»¶æ¶æ„ï¼Œä½“ç°äº†é¢å‘å¯¹è±¡è®¾è®¡çš„ç²¾é«“å’Œæœ€ä½³å®è·µã€‚